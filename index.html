<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff0000">
    <link rel="icon" href="icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#dc2626">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Mini Super Carlitos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@300;400;600;700&family=Courier+Prime&display=swap');
        
        :root {
            --brand-red: #dc2626;
            --brand-white: #ffffff;
            --concrete-bg: #e5e7eb;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--concrete-bg); 
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .header-brand {
            font-family: 'Oswald', sans-serif;
            background-color: var(--brand-red);
            color: white;
            text-transform: uppercase;
            border-bottom: 4px solid #991b1b;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px;}
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-active { 
            background-color: white !important; 
            color: var(--brand-red) !important; 
            border-top: 4px solid var(--brand-red);
            margin-top: -4px;
            font-weight: 800;
        }

        .ticket-font { font-family: 'Courier Prime', monospace; }
        
        .bg-store-gradient {
            background: linear-gradient(rgba(220, 38, 38, 0.95), rgba(153, 27, 27, 0.95)), 
                        url('https://images.unsplash.com/photo-1534723452862-4c874018d66d?auto=format&fit=crop&q=80&w=1000');
            background-size: cover;
            background-position: center;
        }

        .btn-action {
            transition: all 0.15s ease-in-out;
        }
        .btn-action:active { transform: scale(0.96); }

        /* Optimizaciones para m√≥vil */
        @media (max-width: 768px) {
            .pos-layout { flex-direction: column !important; }
            .cart-panel { width: 100% !important; height: 55vh !important; border-width: 2px 0 0 0; border-radius: 1rem 1rem 0 0; }
            .grid-products { grid-template-columns: repeat(2, 1fr) !important; }
            .header-info { display: none; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-store-gradient z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-sm w-full border-t-8 border-red-600">
            <div class="text-center mb-6 md:mb-8">
                <div class="inline-block p-4 bg-red-50 rounded-full mb-4">
                    <i class="fas fa-store text-4xl text-red-600"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-black text-gray-800 font-['Oswald'] uppercase tracking-tight">MINI SUPER CARLITOS</h2>
                <p class="text-gray-500 text-xs font-bold mt-1">SISTEMA POS</p>
            </div>
            
            <div id="role-selection" class="space-y-3">
                <button onclick="selectRole('owner')" class="w-full flex items-center justify-between p-4 border-2 border-gray-100 rounded-xl hover:border-red-500 hover:bg-red-50 transition group btn-action">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-shield text-red-600 text-xl"></i>
                        <span class="font-bold text-gray-700">DUE√ëO</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-600"></i>
                </button>
                <button onclick="selectRole('employee')" class="w-full flex items-center justify-between p-4 border-2 border-gray-100 rounded-xl hover:border-gray-800 hover:bg-gray-50 transition group btn-action">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-cash-register text-gray-700 text-xl"></i>
                        <span class="font-bold text-gray-700">EMPLEADO</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-gray-800"></i>
                </button>
                <div class="text-[10px] text-center text-gray-400 mt-4">
                    PIN Due√±o: admin123 | PIN Empleado: user123
                </div>
            </div>

            <div id="password-entry" class="hidden space-y-4">
                <button onclick="backToRoles()" class="text-xs text-red-600 font-bold mb-2 flex items-center gap-1 hover:text-red-800">
                    <i class="fas fa-arrow-left"></i> VOLVER
                </button>
                <input type="password" id="login-pass" placeholder="PIN" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-red-600 outline-none text-center text-2xl tracking-widest font-bold">
                <button onclick="attemptLogin()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-red-700 btn-action">ENTRAR</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header-brand p-3 md:p-4 flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-3 md:gap-6">
            <div class="flex flex-col">
                <h1 class="text-xl md:text-2xl font-black leading-none tracking-tighter">MINI SUPER CARLITOS</h1>
                <span class="text-[8px] md:text-[10px] font-bold opacity-80">TECNOLOG√çA EN TU BARRIO</span>
            </div>
            <span id="role-indicator" class="text-[8px] md:text-[10px] px-2 py-1 rounded border border-white font-bold uppercase hidden md:inline-block"></span>
        </div>
        <div class="flex items-center gap-4 md:gap-6">
            <div id="clock" class="text-xs md:text-sm font-mono font-bold header-info tracking-widest bg-black/20 px-3 py-1 rounded-lg">00:00:00</div>
            <button onclick="logout()" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition border border-white/20 flex items-center gap-2">
                <i class="fas fa-power-off"></i> <span class="text-xs font-bold hidden md:inline-block">SALIR</span>
            </button>
        </div>
    </header>

    <!-- Navegaci√≥n -->
    <nav id="nav-bar" class="bg-gray-200 border-b flex px-2 md:px-4 gap-1 pt-2 shadow-inner overflow-x-auto custom-scroll z-10 relative"></nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden relative bg-gray-100">
        
        <!-- DASHBOARD (Solo Due√±o) -->
        <div id="view-dashboard" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="flex flex-col md:flex-row gap-3 mt-4">

    <!-- BOTON REPORTE -->
    <button onclick="sendReportWhatsApp()"
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 btn-action border-b-4 border-green-900 active:border-b-0 active:translate-y-1">

        <i class="fab fa-whatsapp text-2xl"></i>
        ENVIAR REPORTE POR WHATSAPP

    </button>

    <!-- BOTON STOCK BAJO -->
    <button onclick="sendLowStockWhatsApp()"
        class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 btn-action border-b-4 border-red-900 active:border-b-0 active:translate-y-1">

        <i class="fab fa-whatsapp text-2xl"></i>
        STOCK BAJO POR WHATSAPP

    </button>

</div>
            <div class="max-w-6xl mx-auto">
                <h2 class="text-2xl font-black text-gray-800 font-['Oswald'] uppercase mb-6 border-l-4 border-red-600 pl-3">Resumen del D√≠a</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-emerald-500">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Ventas de Hoy</span>
                            <i class="fas fa-chart-line text-emerald-100 text-2xl"></i>
                        </div>
                        <div id="profit-day" class="text-4xl md:text-5xl font-black text-emerald-600 mt-2">$0.00</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-red-600">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Fiados Pendientes</span>
                            <i class="fas fa-book-open text-red-100 text-2xl"></i>
                        </div>
                        <div id="total-fiados" class="text-4xl md:text-5xl font-black text-red-600 mt-2">$0.00</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-gray-800">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Stock Cr√≠tico (< 5)</span>
                            <i class="fas fa-exclamation-triangle text-gray-200 text-2xl"></i>
                        </div>
                        <div id="low-stock-count" class="text-4xl md:text-5xl font-black text-gray-800 mt-2">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- POS (Caja) -->
        <div id="view-pos" class="hidden h-full flex flex-col lg:flex-row p-2 md:p-4 gap-2 md:gap-4 pos-layout">
            <div class="flex-1 flex flex-col gap-2 md:gap-4 overflow-hidden">
                <div class="bg-white p-2 md:p-3 rounded-xl shadow-sm flex items-center gap-2 border-2 border-transparent focus-within:border-red-300 transition">
                    <button onclick="openScanner('pos')" class="bg-gray-800 text-white p-3 rounded-lg hover:bg-black transition btn-action flex items-center justify-center">
                        <i class="fas fa-camera text-lg"></i>
                    </button>
                    <div class="bg-red-600 text-white p-3 rounded-lg flex items-center justify-center">
                        <i class="fas fa-barcode text-lg"></i>
                    </div>
                    <input type="text" id="barcode-scanner" oninput="searchProduct(this.value)" placeholder="BUSCAR PRODUCTO..." class="flex-1 text-base md:text-xl font-black outline-none uppercase placeholder:text-gray-300 px-2 bg-transparent">
                    <button onclick="document.getElementById('barcode-scanner').value=''; searchProduct('');" class="text-gray-400 hover:text-red-600 p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="pos-grid" class="flex-1 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-3 overflow-y-auto custom-scroll pr-1 content-start grid-products pb-20 md:pb-0">
                    <!-- Productos inyectados -->
                </div>
            </div>

            <div class="w-full lg:w-[350px] xl:w-[400px] bg-white rounded-xl shadow-xl flex flex-col overflow-hidden border border-gray-200 cart-panel z-20 flex-shrink-0">
                <div class="p-3 bg-gray-800 text-white flex justify-between items-center shadow-md z-10">
                    <h3 class="font-bold text-xs tracking-widest uppercase"><i class="fas fa-shopping-basket mr-2 text-red-400"></i> CARRITO</h3>
                    <button onclick="clearCart()" class="text-[10px] bg-red-600/80 px-3 py-1.5 rounded font-bold hover:bg-red-600 transition">VACIAR</button>
                </div>
                
                <div id="cart-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll bg-gray-50 ticket-font text-xs">
                    <!-- Items carrito -->
                </div>
                
                <div class="p-4 md:p-5 bg-white border-t border-gray-200 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.05)] z-10">
                    <div class="flex justify-between items-end mb-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="text-gray-500 font-black uppercase text-[10px] tracking-widest">Total a Pagar</span>
                        <span id="cart-total" class="text-3xl md:text-4xl font-black text-red-600 leading-none">$0.00</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openCheckout('cash')" class="bg-emerald-600 text-white p-3 rounded-xl font-bold hover:bg-emerald-700 shadow-sm flex flex-col items-center btn-action border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1">
                            <i class="fas fa-money-bill-wave text-2xl mb-1 opacity-80"></i> 
                            <span class="text-[10px] tracking-widest">EFECTIVO</span>
                        </button>
                        <button onclick="openCheckout('fiado')" class="bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 shadow-sm flex flex-col items-center btn-action border-b-4 border-red-800 active:border-b-0 active:translate-y-1">
                            <i class="fas fa-book text-2xl mb-1 opacity-80"></i> 
                            <span class="text-[10px] tracking-widest">FIAR</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RECARGAS -->
        <div id="view-recargas" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-blue-600 mb-6">
                    <h2 class="text-2xl md:text-3xl font-black font-['Oswald'] text-gray-800 uppercase">Recargas Telef√≥nicas</h2>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">SELECCIONA COMPA√ë√çA Y MONTO</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-black text-gray-700 mb-4 uppercase text-sm border-b pb-2">1. Compa√±√≠a</h3>
                        <div class="grid grid-cols-3 gap-3" id="company-selector">
                            <button onclick="selectCompany('Telcel')" class="company-btn p-4 rounded-xl border-2 border-gray-200 hover:border-blue-500 flex flex-col items-center gap-2 transition">
                                <i class="fas fa-signal text-blue-600 text-2xl"></i>
                                <span class="text-xs font-bold text-gray-700">Telcel</span>
                            </button>
                            <button onclick="selectCompany('Movistar')" class="company-btn p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 flex flex-col items-center gap-2 transition">
                                <i class="fas fa-signal text-green-500 text-2xl"></i>
                                <span class="text-xs font-bold text-gray-700">Movistar</span>
                            </button>
                            <button onclick="selectCompany('AT&T')" class="company-btn p-4 rounded-xl border-2 border-gray-200 hover:border-orange-500 flex flex-col items-center gap-2 transition">
                                <i class="fas fa-signal text-orange-500 text-2xl"></i>
                                <span class="text-xs font-bold text-gray-700">AT&T</span>
                            </button>
                        </div>

                        <h3 class="font-black text-gray-700 mb-4 mt-6 uppercase text-sm border-b pb-2">2. N√∫mero a 10 d√≠gitos</h3>
                        <input type="tel" id="recarga-phone" maxlength="10" placeholder="Ej: 5512345678" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-center text-xl tracking-[0.3em] outline-none focus:border-blue-500 transition">
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-black text-gray-700 mb-4 uppercase text-sm border-b pb-2">3. Monto</h3>
                        <div class="grid grid-cols-2 gap-3 mb-6" id="amount-selector">
                            <button onclick="selectAmount(20)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 text-lg font-black text-gray-700 transition">$20</button>
                            <button onclick="selectAmount(50)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 text-lg font-black text-gray-700 transition">$50</button>
                            <button onclick="selectAmount(100)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 text-lg font-black text-gray-700 transition">$100</button>
                            <button onclick="selectAmount(200)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 text-lg font-black text-gray-700 transition">$200</button>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center mb-4">
                            <span class="text-[10px] font-black text-gray-400 uppercase block">Resumen</span>
                            <div class="text-lg font-bold text-gray-800 mt-1" id="recarga-summary">Selecciona opciones</div>
                        </div>

                        <button onclick="processRecarga()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-blue-700 uppercase tracking-widest btn-action flex items-center justify-center gap-2 disabled:opacity-50" id="btn-process-recarga">
                            <i class="fas fa-bolt"></i> ENVIAR RECARGA
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FIADOS (Clientes) -->
        <div id="view-fiados" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 bg-white p-5 rounded-2xl shadow-sm border-l-8 border-red-600">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black font-['Oswald'] text-gray-800 uppercase">Clientes / Fiados</h2>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">GESTI√ìN DE CUENTAS POR COBRAR</p>
                    </div>
                    <!-- Bot√≥n oculto para empleados mediante JS -->
                    <button id="btn-new-customer" onclick="openModal('customer-add-modal')" class="w-full md:w-auto bg-gray-800 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-black transition flex items-center justify-center gap-2 btn-action">
                        <i class="fas fa-user-plus"></i> NUEVO CLIENTE
                    </button>
                </div>
                
                <div class="mb-4 relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-customer" oninput="renderCustomers(this.value)" placeholder="BUSCAR CLIENTE..." class="w-full bg-white p-4 pl-12 rounded-xl shadow-sm outline-none font-bold uppercase border-2 border-transparent focus:border-red-300 transition">
                </div>

                <div id="customers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Clientes inyectados -->
                </div>
            </div>
        </div>

        <!-- INVENTARIO (Solo Due√±o) -->
        <div id="view-inventory" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="bg-white rounded-2xl shadow-sm max-w-6xl mx-auto overflow-hidden flex flex-col h-full md:h-auto">
                <div class="p-4 md:p-6 bg-gray-800 text-white flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                    <div>
                        <h2 class="text-xl font-black uppercase font-['Oswald'] tracking-wide">Inventario</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">ADMINISTRACI√ìN DE PRODUCTOS</p>
                    </div>
                    <div class="flex w-full sm:w-auto gap-2">
                        <button onclick="openProductModal()" class="flex-1 sm:flex-none bg-red-600 text-white px-4 py-2.5 rounded-lg text-xs font-bold hover:bg-red-700 flex items-center justify-center gap-2 transition">
                            <i class="fas fa-plus"></i> PRODUCTO
                        </button>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="relative max-w-md">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-inventory" oninput="renderInventory(this.value)" placeholder="BUSCAR EN INVENTARIO..." class="w-full bg-white p-3 pl-10 rounded-lg outline-none font-bold uppercase border border-gray-300 focus:border-red-500 text-sm">
                    </div>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full min-w-[700px] text-left">
                        <thead class="bg-gray-100 text-gray-500 text-[10px] font-black uppercase tracking-widest border-b">
                            <tr>
                                <th class="p-4 w-16 text-center">C√≥digo</th>
                                <th class="p-4">Producto</th>
                                <th class="p-4 text-right">Costo</th>
                                <th class="p-4 text-right">Precio Venta</th>
                                <th class="p-4 text-center">Stock</th>
                                <th class="p-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body" class="divide-y divide-gray-100 bg-white text-sm font-medium text-gray-700">
                            <!-- Inventario inyectado -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- ========================================== -->
    <!-- MODALES -->
    <!-- ========================================== -->

    <!-- Modal Esc√°ner Gen√©rico -->
    <div id="scanner-modal" class="hidden fixed inset-0 bg-black/95 z-[2000] flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="w-full max-w-md bg-white rounded-2xl overflow-hidden shadow-2xl relative">
            <div class="p-4 bg-red-600 text-white text-center font-black uppercase tracking-widest flex justify-between items-center">
                <span>Escanear C√≥digo</span>
                <button onclick="closeScanner()" class="text-white hover:text-red-200 p-1"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="reader" class="w-full bg-black min-h-[300px]"></div>
            <div class="p-4 bg-gray-50 text-center">
                <p class="text-xs text-gray-500 font-bold mb-3 uppercase">Apunta la c√°mara al c√≥digo de barras</p>
                <button onclick="closeScanner()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold uppercase text-xs btn-action">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Checkout -->
    <div id="checkout-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 border-t-8 border-red-600 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-start mb-4">
                <h3 id="checkout-title" class="text-lg font-black uppercase tracking-widest text-gray-800">COBRAR</h3>
                <button onclick="closeModal('checkout-modal')" class="text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100 text-center">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">TOTAL A COBRAR</span>
                <div id="checkout-total-display" class="text-5xl font-black text-red-600 font-['Oswald']"></div>
            </div>
            
            <div id="cash-payment-fields" class="space-y-4 hidden">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Efectivo Recibido</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-black text-2xl">$</span>
                        <input type="number" id="cash-received" oninput="calcChange()" placeholder="0.00" class="w-full p-4 pl-10 bg-white border-2 border-gray-200 rounded-xl text-3xl text-right font-black focus:border-emerald-500 outline-none transition">
                    </div>
                </div>
                <div class="bg-emerald-50 p-4 rounded-xl border-2 border-emerald-100 flex justify-between items-center">
                    <span class="text-[10px] text-emerald-800 font-black uppercase">Cambio</span>
                    <div id="cash-change" class="text-2xl font-black text-emerald-600">$0.00</div>
                </div>
            </div>

            <div id="fiado-fields" class="space-y-4 hidden">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Seleccionar Cliente</label>
                    <select id="customer-select" class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl font-bold text-gray-700 outline-none focus:border-red-500 transition">
                        <!-- Opciones -->
                    </select>
                </div>
                <div class="text-[10px] text-center text-gray-500 bg-gray-50 p-3 rounded-lg border border-dashed border-gray-300">
                    Esta venta se registrar√° como deuda en la cuenta del cliente seleccionado.
                </div>
            </div>

            <div class="pt-6 space-y-3">
                <button onclick="finalizeSale()" class="w-full bg-red-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-red-700 uppercase tracking-widest btn-action flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> CONFIRMAR VENTA
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Producto (Crear/Editar) -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md border-t-8 border-gray-800 shadow-2xl relative max-h-[90vh] overflow-y-auto custom-scroll">
            <button onclick="closeModal('product-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            
            <h3 id="product-modal-title" class="font-black mb-6 text-xl uppercase tracking-widest text-gray-800">NUEVO PRODUCTO</h3>
            
            <form id="product-form" class="space-y-4" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="p-id">
                
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">C√≥digo de Barras</label>
                    <div class="flex gap-2">
                        <input type="text" id="p-code" placeholder="ESCRIBE O ESCANEA..." class="flex-1 p-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-mono font-bold outline-none focus:border-red-500 uppercase">
                    <button type="button"
        onclick="openScanner('stock')"
        class="bg-gray-800 hover:bg-black text-white px-4 py-3 rounded-xl font-bold transition btn-action flex items-center justify-center gap-2 shadow-md border-b-4 border-gray-900 active:border-b-0 active:translate-y-[2px]">

    <i class="fas fa-camera text-lg"></i>
    <span class="hidden sm:inline">ESCANEAR</span>

</button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Nombre del Producto</label>
                    <input type="text" id="p-name" required placeholder="EJ: COCA COLA 600ML" class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold uppercase outline-none focus:border-red-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Costo Compra</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                            <input type="number" id="p-cost" step="0.01" min="0" required placeholder="0.00" class="w-full p-3 pl-8 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold outline-none focus:border-red-500 text-right">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-red-500 uppercase ml-1">Precio Venta</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-400 font-bold">$</span>
                            <input type="number" id="p-price" step="0.01" min="0" required placeholder="0.00" class="w-full p-3 pl-8 bg-red-50 border-2 border-red-200 rounded-xl font-black text-red-600 outline-none focus:border-red-500 text-right">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Stock Actual</label>
                    <input type="number" id="p-stock" required min="0" placeholder="0" class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-black text-center text-xl outline-none focus:border-red-500">
                </div>
                
                <div class="pt-4 flex gap-3">
        
                    <button type="button" onclick="closeModal('product-modal')" class="flex-1 bg-gray-200 text-gray-600 py-4 rounded-xl font-black uppercase text-xs btn-action">CANCELAR</button>
                    <button type="submit" class="flex-[2] bg-gray-800 text-white py-4 rounded-xl font-black uppercase text-sm hover:bg-black transition shadow-md btn-action">GUARDAR DATOS</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Agregar Cliente -->
    <div id="customer-add-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm border-t-8 border-gray-800 shadow-2xl relative">
            <button onclick="closeModal('customer-add-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-black mb-6 uppercase tracking-widest text-gray-800">NUEVO CLIENTE</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Nombre Completo / Apodo</label>
                    <input type="text" id="new-cust-name" placeholder="EJ: DO√ëA MAR√çA" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold uppercase outline-none focus:border-gray-800">
                </div>
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Tel√©fono (Opcional)</label>
                    <input type="text" id="new-cust-phone" placeholder="000 000 0000" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold outline-none focus:border-gray-800">
                </div>
                <button onclick="saveNewCustomer()" class="w-full bg-red-600 text-white py-4 rounded-xl font-black text-sm shadow-lg hover:bg-red-700 uppercase btn-action mt-2">REGISTRAR CLIENTE</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Cliente (Abonos) -->
    <div id="customer-detail-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[650] flex items-center justify-center p-2 md:p-4">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] shadow-2xl">
            <div class="p-4 bg-red-600 text-white flex justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="bg-white/20 p-2 rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <h3 id="det-cust-name" class="text-lg font-black font-['Oswald'] uppercase truncate"></h3>
                </div>
                <button onclick="closeModal('customer-detail-modal')" class="text-white hover:text-red-200 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 bg-gradient-to-b from-red-50 to-white text-center border-b border-gray-100 relative">
                <span class="text-[10px] font-black text-red-400 uppercase tracking-widest block mb-1">Deuda Total Actual</span>
                <div id="det-cust-balance" class="text-5xl font-black text-red-600 font-['Oswald'] tracking-tight"></div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-4 bg-gray-50">
                <!-- Zona de Abono -->
                <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm">
                    <p class="text-[10px] font-black text-gray-500 uppercase mb-3 flex items-center gap-2"><i class="fas fa-hand-holding-usd text-emerald-500"></i> Registrar Abono</p>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
                            <input type="number" id="abono-monto" min="0" placeholder="0.00" class="w-full p-3 pl-8 bg-gray-50 border-2 border-gray-200 rounded-xl font-black text-lg outline-none focus:border-emerald-500">
                        </div>
                        <button onclick="registerAbono()" class="bg-emerald-600 text-white px-6 rounded-xl font-black uppercase text-sm hover:bg-emerald-700 btn-action shadow-md">OK</button>
                    </div>
                </div>

                <!-- Historial -->
                <div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">Historial de Movimientos</h4>
                    <div id="customer-history" class="space-y-2">
                        <!-- Movimientos -->
                    </div>
                </div>
            </div>

            <div id="customer-footer-actions" class="p-4 border-t border-gray-200 bg-white grid gap-3">
                <!-- Se inyectan din√°micamente seg√∫n si es empleado o due√±o -->
            </div>
        </div>
    </div>
<audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>
    <!-- Script de L√≥gica Principal -->
    <script>
    
const WHATSAPP_NUMBER = "2371062600"; 

//------------------------------------------------
// REPORTE COMPLETO
//------------------------------------------------
function sendReportWhatsApp(){

    const sales = JSON.parse(localStorage.getItem("sales")) || [];
    const products = JSON.parse(localStorage.getItem("products")) || [];

    let today = new Date().toISOString().slice(0,10);
    let currentMonth = today.slice(0,7);

    let gananciasDia = 0;
    let ventasDia = 0;
    let ventasMes = 0;
    let totalVentas = sales.length;

    let contadorProductos = {};

    sales.forEach(sale=>{

        if(sale.date.startsWith(today)){
            gananciasDia += sale.total;
            ventasDia++;
        }

        if(sale.date.startsWith(currentMonth)){
            ventasMes++;
        }

        sale.items.forEach(item=>{
            contadorProductos[item.name] =
                (contadorProductos[item.name] || 0) + item.qty;
        });

    });

    let masVendido = "Ninguno";
    let max = 0;

    for(let p in contadorProductos){
        if(contadorProductos[p] > max){
            max = contadorProductos[p];
            masVendido = p;
        }
    }

    let mensaje =
`üìä REPORTE MINI SUPER CARLITOS

üí∞ Ganancias del d√≠a: $${gananciasDia.toFixed(2)}

üì¶ Producto m√°s vendido:
${masVendido}

üßæ Ventas hoy: ${ventasDia}

üìÖ Ventas del mes: ${ventasMes}

üìä Ventas totales: ${totalVentas}

Fecha: ${new Date().toLocaleString()}
`;

    abrirWhatsApp(mensaje);

}


//------------------------------------------------
// STOCK BAJO
//------------------------------------------------
function sendLowStockWhatsApp(){

    const products = JSON.parse(localStorage.getItem("products")) || [];

    let bajos = products.filter(p=>p.stock <= 5);

    if(bajos.length === 0){
        alert("No hay stock bajo");
        return;
    }

    let mensaje =
`‚ö†Ô∏è STOCK BAJO - MINI SUPER CARLITOS

`;

    bajos.forEach(p=>{

        mensaje +=
`${p.name}
Stock: ${p.stock}
C√≥digo: ${p.code}

`;

    });

    abrirWhatsApp(mensaje);

}


//------------------------------------------------
// ABRIR WHATSAPP
//------------------------------------------------
function abrirWhatsApp(texto){

    let url =
`https://wa.me/2371062600?text=${encodeURIComponent(texto)}`;

    window.open(url,"_blank");

}
        // --- BASE DE DATOS SIMULADA ---
        let currentRole = null;
        let selectedRoleForLogin = null;
        
        let products = [
            { id: 1, code: '7501055300075', name: 'COCA COLA 600ML', cost: 12.00, price: 18.00, stock: 24 },
            { id: 2, code: '7501000111202', name: 'BIMBO PAN BLANCO', cost: 35.00, price: 45.00, stock: 10 },
            { id: 3, code: '7501030434559', name: 'SABRITAS SAL 40G', cost: 13.00, price: 17.00, stock: 3 },
            { id: 4, code: '7501020434551', name: 'LECHE LALA 1L', cost: 22.00, price: 28.00, stock: 15 },
        ];

        let customers = [
            { id: 1, name: 'DO√ëA MAR√çA', phone: '5512345678', balance: 150.50, history: [{ date: '2023-10-01 10:00', desc: 'Compra a cr√©dito', amount: 150.50, type: 'cargo' }] },
            { id: 2, name: 'JUAN P√âREZ', phone: '', balance: 45.00, history: [{ date: '2023-10-02 12:00', desc: 'Compra a cr√©dito', amount: 45.00, type: 'cargo' }] }
        ];

        let cart = [];
        let dailyStats = { sales: 0, fiados: 0 };
        let activeCheckoutMode = 'cash';
        let activeCustomerId = null;

        // --- ESTADOS DE RECARGAS ---
        let selectedRecargaCompany = null;
        let selectedRecargaAmount = null;

        // --- RELOJ ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }, 1000);

        // --- LOGIN ---
        function selectRole(role) {
            selectedRoleForLogin = role;
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('password-entry').classList.remove('hidden');
            document.getElementById('login-pass').value = '';
            document.getElementById('login-pass').focus();
        }

        function backToRoles() {
            document.getElementById('password-entry').classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
        }

        function attemptLogin() {
            const pass = document.getElementById('login-pass').value;
            if ((selectedRoleForLogin === 'owner' && pass === 'admin123') || 
                (selectedRoleForLogin === 'employee' && pass === 'user123')) {
                currentRole = selectedRoleForLogin;
                initApp();
            } else {
                Swal.fire({ icon: 'error', title: 'PIN Incorrecto', text: 'Intenta nuevamente', confirmButtonColor: '#dc2626' });
            }
        }

        function logout() {
            currentRole = null;
            document.getElementById('login-overlay').classList.remove('hidden');
            backToRoles();
        }

        // --- INICIALIZACI√ìN DE APP ---
        function initApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('role-indicator').innerText = currentRole === 'owner' ? 'Due√±o' : 'Empleado';
            document.getElementById('role-indicator').className = `text-[8px] md:text-[10px] px-2 py-1 rounded font-bold uppercase hidden md:inline-block ${currentRole === 'owner' ? 'bg-yellow-500 text-yellow-900' : 'bg-gray-200 text-gray-800'}`;
            
            // Restricciones visuales directas
            document.getElementById('btn-new-customer').style.display = currentRole === 'owner' ? 'flex' : 'none';

            buildNavigation();
            updateDashboard();
            renderPOS();
            renderCustomers();
            if(currentRole === 'owner') renderInventory();
            
            // Switch al primer tab permitido
            const firstTab = currentRole === 'owner' ? 'dashboard' : 'pos';
            switchView(firstTab);
        }

        function buildNavigation() {
            const nav = document.getElementById('nav-bar');
            nav.innerHTML = '';
            
            const tabs = [
                { id: 'dashboard', icon: 'fas fa-chart-pie', label: 'Dashboard', roles: ['owner'] },
                { id: 'pos', icon: 'fas fa-cash-register', label: 'Caja', roles: ['owner', 'employee'] },
                { id: 'recargas', icon: 'fas fa-mobile-alt', label: 'Recargas', roles: ['owner', 'employee'] },
                { id: 'fiados', icon: 'fas fa-book', label: 'Fiados', roles: ['owner', 'employee'] },
                { id: 'inventory', icon: 'fas fa-box', label: 'Inventario', roles: ['owner'] }
            ];

            tabs.forEach(tab => {
                if(tab.roles.includes(currentRole)) {
                    const btn = document.createElement('button');
                    btn.onclick = () => switchView(tab.id);
                    btn.className = `nav-btn px-4 py-3 text-xs md:text-sm font-bold text-gray-500 rounded-t-xl hover:bg-gray-100 transition flex items-center gap-2 tracking-wide uppercase`;
                    btn.setAttribute('data-target', tab.id);
                    btn.innerHTML = `<i class="${tab.icon}"></i> <span class="hidden sm:inline">${tab.label}</span>`;
                    nav.appendChild(btn);
                }
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                if(btn.getAttribute('data-target') === viewId) btn.classList.add('tab-active');
            });
        }

        // --- FUNCIONALIDAD CAJA (POS) ---
        function renderPOS(query = '') {
            const grid = document.getElementById('pos-grid');
            grid.innerHTML = '';
            
            const filtered = products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()) || p.code.includes(query));
            
            filtered.forEach(p => {
                const stockColor = p.stock > 5 ? 'text-gray-500' : 'text-red-500 font-bold';
                const card = document.createElement('button');
                card.onclick = () => addToCart(p.id);
                card.className = `bg-white p-3 rounded-xl border border-gray-200 hover:border-red-400 hover:shadow-md transition text-left flex flex-col justify-between h-28 btn-action ${p.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}`;
                card.innerHTML = `
                    <div class="text-[10px] text-gray-400 font-mono">${p.code}</div>
                    <div class="font-bold text-gray-800 text-sm leading-tight uppercase line-clamp-2">${p.name}</div>
                    <div class="flex justify-between items-end mt-2">
                        <span class="font-black text-red-600">$${p.price.toFixed(2)}</span>
                        <span class="text-[9px] ${stockColor} uppercase">Stock: ${p.stock}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function searchProduct(val) { renderPOS(val); }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            if(p.stock <= 0) {
                Swal.fire({ icon: 'warning', title: 'Sin Stock', text: 'No hay unidades disponibles.', timer: 1500, showConfirmButton: false });
                return;
            }

            const item = cart.find(x => x.id === id);
            if(item) {
                if(item.qty >= p.stock) return Swal.fire({ icon: 'warning', title: 'L√≠mite de Stock', timer: 1000, showConfirmButton: false });
                item.qty++;
            } else {
                cart.push({ ...p, qty: 1 });
            }
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                total += item.price * item.qty;
                const div = document.createElement('div');
                div.className = 'bg-white p-2 rounded border border-gray-100 flex justify-between items-center shadow-sm';
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold truncate w-40 sm:w-48">${item.name}</div>
                        <div class="text-gray-400">$${item.price.toFixed(2)} x ${item.qty}</div>
                    </div>
                    <div class="font-black text-gray-800 mr-3">$${(item.price * item.qty).toFixed(2)}</div>
                    <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 bg-red-50 p-1.5 rounded"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(div);
            });

            document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
        }

        function clearCart() {
            cart = [];
            updateCartUI();
        }

        // --- CHECKOUT ---
        function openCheckout(mode) {
            if(cart.length === 0) return Swal.fire({ icon: 'info', title: 'Carrito vac√≠o', timer: 1000, showConfirmButton: false });
            
            activeCheckoutMode = mode;
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            
            document.getElementById('checkout-title').innerText = mode === 'cash' ? 'COBRO EN EFECTIVO' : 'VENTA A CR√âDITO (FIADO)';
            document.getElementById('checkout-total-display').innerText = `$${total.toFixed(2)}`;
            
            document.getElementById('cash-payment-fields').classList.add('hidden');
            document.getElementById('fiado-fields').classList.add('hidden');
            
            if(mode === 'cash') {
                document.getElementById('cash-payment-fields').classList.remove('hidden');
                document.getElementById('cash-received').value = '';
                document.getElementById('cash-change').innerText = '$0.00';
                setTimeout(() => document.getElementById('cash-received').focus(), 100);
            } else {
                document.getElementById('fiado-fields').classList.remove('hidden');
                populateCustomerSelect();
            }
            
            document.getElementById('checkout-modal').classList.remove('hidden');
        }

        function calcChange() {
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = received - total;
            const changeEl = document.getElementById('cash-change');
            
            if(change >= 0) {
                changeEl.innerText = `$${change.toFixed(2)}`;
                changeEl.className = 'text-2xl font-black text-emerald-600';
            } else {
                changeEl.innerText = `Faltan $${Math.abs(change).toFixed(2)}`;
                changeEl.className = 'text-lg font-black text-red-500';
            }
        }

        function finalizeSale() {
            let sales = JSON.parse(localStorage.getItem("sales")) || [];

sales.push({

    items: cart,
    total: total,
    date: new Date().toISOString()

});
localStorage.setItem("products", JSON.stringify(products));
localStorage.setItem("customers", JSON.stringify(customers));

localStorage.setItem("sales", JSON.stringify(sales));
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            
            if(activeCheckoutMode === 'cash') {
                const received = parseFloat(document.getElementById('cash-received').value) || 0;
                if(received < total) return Swal.fire({ icon: 'error', title: 'Efectivo insuficiente', confirmButtonColor: '#dc2626' });
                dailyStats.sales += total;
            } else {
                const cid = parseInt(document.getElementById('customer-select').value);
                if(!cid) return Swal.fire({ icon: 'error', title: 'Selecciona un cliente', confirmButtonColor: '#dc2626' });
                
                const c = customers.find(x => x.id === cid);
                c.balance += total;
                c.history.unshift({ date: new Date().toLocaleString(), desc: 'Compra a cr√©dito', amount: total, type: 'cargo' });
                dailyStats.fiados += total;
            }

            // Reducir stock
            cart.forEach(item => {
                const p = products.find(x => x.id === item.id);
                if(p) p.stock -= item.qty;
            });

            closeModal('checkout-modal');
            clearCart();
            updateDashboard();
            renderPOS();
            if(currentRole === 'owner') renderInventory();
            renderCustomers();

            Swal.fire({
                icon: 'success',
                title: 'Venta Registrada',
                showConfirmButton: false,
                timer: 1500
            });
        }

        // --- RECARGAS (Nuevo M√≥dulo) ---
        function selectCompany(name) {
            selectedRecargaCompany = name;
            document.querySelectorAll('.company-btn').forEach(btn => btn.classList.remove('border-blue-500', 'bg-blue-50'));
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
            updateRecargaSummary();
        }

        function selectAmount(amount) {
            selectedRecargaAmount = amount;
            document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('border-red-500', 'bg-red-50'));
            event.currentTarget.classList.add('border-red-500', 'bg-red-50');
            updateRecargaSummary();
        }

        function updateRecargaSummary() {
            const phone = document.getElementById('recarga-phone').value;
            const summaryEl = document.getElementById('recarga-summary');
            
            if (selectedRecargaCompany && selectedRecargaAmount && phone.length === 10) {
                summaryEl.innerHTML = `<span class="text-blue-600">${selectedRecargaCompany}</span> - $${selectedRecargaAmount} al <span class="tracking-wider">${phone}</span>`;
            } else {
                summaryEl.innerText = 'Faltan datos para recarga';
            }
        }

        document.getElementById('recarga-phone').addEventListener('input', updateRecargaSummary);

        function processRecarga() {
            const phone = document.getElementById('recarga-phone').value;
            if (!selectedRecargaCompany) return Swal.fire('Atenci√≥n', 'Selecciona una compa√±√≠a', 'warning');
            if (phone.length !== 10) return Swal.fire('Atenci√≥n', 'Ingresa un n√∫mero de 10 d√≠gitos', 'warning');
            if (!selectedRecargaAmount) return Swal.fire('Atenci√≥n', 'Selecciona un monto', 'warning');

            const btn = document.getElementById('btn-process-recarga');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESANDO...';
            btn.disabled = true;

            // Simular proceso de 2 segundos
            setTimeout(() => {
                // Registrar como venta
                dailyStats.sales += selectedRecargaAmount;
                updateDashboard();

                Swal.fire({
                    icon: 'success',
                    title: 'Recarga Exitosa',
                    html: `Se abonaron <b>$${selectedRecargaAmount}</b> a <b>${phone}</b> (${selectedRecargaCompany})`,
                    confirmButtonColor: '#2563eb'
                });

                // Limpiar
                document.getElementById('recarga-phone').value = '';
                selectedRecargaCompany = null;
                selectedRecargaAmount = null;
                document.querySelectorAll('.company-btn, .amount-btn').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50', 'border-red-500', 'bg-red-50'));
                updateRecargaSummary();
                
                btn.innerHTML = '<i class="fas fa-bolt"></i> ENVIAR RECARGA';
                btn.disabled = false;

            }, 2000);
        }

        // --- FIADOS Y CLIENTES ---
        function renderCustomers(query = '') {
            const grid = document.getElementById('customers-grid');
            grid.innerHTML = '';
            
            const filtered = customers.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
            
            filtered.forEach(c => {
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:border-red-300 transition relative overflow-hidden group';
                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-1 h-full ${c.balance > 0 ? 'bg-red-500' : 'bg-emerald-500'}"></div>
                    <h4 class="font-black text-gray-800 uppercase pl-2 text-lg truncate">${c.name}</h4>
                    <p class="text-[10px] text-gray-400 font-bold ml-2 uppercase mb-4"><i class="fas fa-phone"></i> ${c.phone || 'SIN TEL√âFONO'}</p>
                    <div class="ml-2 bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase text-gray-500">Deuda</span>
                        <span class="font-black text-xl ${c.balance > 0 ? 'text-red-600' : 'text-emerald-600'}">$${c.balance.toFixed(2)}</span>
                    </div>
                    <button onclick="openCustomerDetail(${c.id})" class="w-full mt-3 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-xs transition">
                        VER DETALLES / ABONAR
                    </button>
                `;
                grid.appendChild(card);
            });
            
            // Actualizar total en dashboard
            document.getElementById('total-fiados').innerText = `$${customers.reduce((s, c) => s + c.balance, 0).toFixed(2)}`;
        }

        function populateCustomerSelect() {
            const sel = document.getElementById('customer-select');
            sel.innerHTML = '<option value="">-- SELECCIONA --</option>';
            customers.forEach(c => {
                sel.innerHTML += `<option value="${c.id}">${c.name} (Deuda actual: $${c.balance.toFixed(2)})</option>`;
            });
        }

        function saveNewCustomer() {
            const name = document.getElementById('new-cust-name').value.toUpperCase();
            const phone = document.getElementById('new-cust-phone').value;
            
            if(!name) return Swal.fire('Error', 'El nombre es obligatorio', 'error');
            
            customers.push({ id: Date.now(), name, phone, balance: 0, history: [] });
            closeModal('customer-add-modal');
            document.getElementById('new-cust-name').value = '';
            document.getElementById('new-cust-phone').value = '';
            renderCustomers();
            Swal.fire({icon: 'success', title: 'Cliente Registrado', timer: 1000, showConfirmButton: false});
        }

        function openCustomerDetail(id) {
            activeCustomerId = id;
            const c = customers.find(x => x.id === id);
            
            document.getElementById('det-cust-name').innerText = c.name;
            document.getElementById('det-cust-balance').innerText = `$${c.balance.toFixed(2)}`;
            document.getElementById('abono-monto').value = '';
            
            const hist = document.getElementById('customer-history');
            hist.innerHTML = c.history.length === 0 ? '<div class="text-xs text-center text-gray-400 py-4">Sin movimientos</div>' : '';
            c.history.forEach(h => {
                hist.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b border-gray-100 text-xs">
                        <div>
                            <span class="block font-bold text-gray-700">${h.desc}</span>
                            <span class="text-[9px] text-gray-400">${h.date}</span>
                        </div>
                        <span class="font-black ${h.type === 'abono' ? 'text-emerald-500' : 'text-red-500'}">
                            ${h.type === 'abono' ? '+' : '-'}$${h.amount.toFixed(2)}
                        </span>
                    </div>
                `;
            });

            // L√≥gica de Permisos de Botones de Acci√≥n (Due√±o vs Empleado)
            const actionsFooter = document.getElementById('customer-footer-actions');
            actionsFooter.innerHTML = ''; // Limpiar botones

            if(currentRole === 'owner') {
                actionsFooter.className = "p-4 border-t border-gray-200 bg-white grid grid-cols-2 gap-3";
                actionsFooter.innerHTML = `
                    <button onclick="liquidarDeuda()" class="bg-gray-800 text-white py-3 rounded-xl font-bold uppercase text-xs hover:bg-black transition btn-action flex items-center justify-center gap-2">
                        <i class="fas fa-check-double"></i> LIQUIDAR DEUDA
                    </button>
                    <button onclick="deleteCustomer()" class="bg-red-50 text-red-600 border border-red-200 py-3 rounded-xl font-bold uppercase text-xs hover:bg-red-100 transition btn-action flex items-center justify-center gap-2">
                        <i class="fas fa-trash"></i> ELIMINAR CLIENTE
                    </button>
                `;
            } else {
                // Empleado solo puede cerrar la ventana (el abono se hace arriba)
                actionsFooter.className = "p-4 border-t border-gray-200 bg-white flex justify-center";
                actionsFooter.innerHTML = `
                    <button onclick="closeModal('customer-detail-modal')" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold uppercase text-xs hover:bg-gray-300 transition btn-action">
                        CERRAR VENTANA
                    </button>
                `;
            }
            
            document.getElementById('customer-detail-modal').classList.remove('hidden');
        }

        function registerAbono() {
            const monto = parseFloat(document.getElementById('abono-monto').value);
            if(!monto || monto <= 0) return Swal.fire('Error', 'Ingresa un monto v√°lido', 'warning');
            
            const c = customers.find(x => x.id === activeCustomerId);
            if(monto > c.balance && currentRole === 'employee') {
                 return Swal.fire('Error', 'El abono no puede superar la deuda', 'warning');
            }
            
            c.balance = Math.max(0, c.balance - monto);
            c.history.unshift({ date: new Date().toLocaleString(), desc: 'Abono recibido', amount: monto, type: 'abono' });
            
            dailyStats.sales += monto; // Abonos entran como venta/ingreso al caj√≥n
            
            updateDashboard();
            renderCustomers();
            openCustomerDetail(activeCustomerId); // refrescar modal
            Swal.fire({icon: 'success', title: 'Abono Registrado', timer: 1000, showConfirmButton: false});
        }

        function liquidarDeuda() {
            const c = customers.find(x => x.id === activeCustomerId);
            if(c.balance === 0) return Swal.fire('Info', 'La deuda ya est√° en cero', 'info');

            Swal.fire({
                title: '¬øLiquidar deuda?',
                text: `¬øEl cliente ha pagado los $${c.balance.toFixed(2)} restantes?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, liquidar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const monto = c.balance;
                    c.balance = 0;
                    c.history.unshift({ date: new Date().toLocaleString(), desc: 'Liquidaci√≥n total', amount: monto, type: 'abono' });
                    dailyStats.sales += monto;
                    updateDashboard();
                    renderCustomers();
                    openCustomerDetail(activeCustomerId);
                    Swal.fire('Liquidado!', 'La deuda qued√≥ en ceros.', 'success');
                }
            });
        }

        function deleteCustomer() {
            Swal.fire({
                title: '¬øEliminar cliente?',
                text: "Esta acci√≥n no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    customers = customers.filter(x => x.id !== activeCustomerId);
                    renderCustomers();
                    closeModal('customer-detail-modal');
                    Swal.fire('Eliminado!', 'El cliente ha sido borrado.', 'success');
                }
            });
        }

        // --- INVENTARIO ---
        function renderInventory(query = '') {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            
            let lowStock = 0;
            const filtered = products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()) || p.code.includes(query));
            
            filtered.forEach(p => {
                if(p.stock < 5) lowStock++;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 text-center font-mono text-xs text-gray-500">${p.code}</td>
                    <td class="p-4 font-bold uppercase">${p.name}</td>
                    <td class="p-4 text-right text-gray-500">$${p.cost.toFixed(2)}</td>
                    <td class="p-4 text-right font-black text-red-600">$${p.price.toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded text-xs font-bold ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">${p.stock}</span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="editProduct(${p.id})" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700 mx-1"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('low-stock-count').innerText = lowStock;
        }

        function openProductModal() {
            document.getElementById('product-form').reset();
            document.getElementById('p-id').value = '';
            document.getElementById('product-modal-title').innerText = 'NUEVO PRODUCTO';
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-code').value = p.code;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-cost').value = p.cost;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-stock').value = p.stock;
            document.getElementById('product-modal-title').innerText = 'EDITAR PRODUCTO';
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('p-id').value;
            const pData = {
                code: document.getElementById('p-code').value || Math.floor(Math.random() * 1000000000000).toString(),
                name: document.getElementById('p-name').value.toUpperCase(),
                cost: parseFloat(document.getElementById('p-cost').value),
                price: parseFloat(document.getElementById('p-price').value),
                stock: parseInt(document.getElementById('p-stock').value)
            };

            if(id) {
                const idx = products.findIndex(x => x.id == id);
                products[idx] = { ...products[idx], ...pData };
            } else {
                products.push({ id: Date.now(), ...pData });
            }

            closeModal('product-modal');
            renderInventory();
            renderPOS();
            Swal.fire({icon: 'success', title: 'Guardado', timer: 1000, showConfirmButton: false});
        }

        function deleteProduct(id) {
            Swal.fire({
                title: '¬øBorrar producto?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S√≠, borrar',
            }).then((result) => {
                if (result.isConfirmed) {
                    products = products.filter(x => x.id !== id);
                    renderInventory();
                    renderPOS();
                }
            });
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            document.getElementById('profit-day').innerText = `$${dailyStats.sales.toFixed(2)}`;
        }

        // --- MODALES UTILS ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function openScanner(mode){

    currentScanMode = mode;

    document.getElementById("scanner-modal").classList.remove("hidden");

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        { facingMode: "environment" }, // CAMARA TRASERA
        {
            fps: 10,
            qrbox: 250
        },
        onScanSuccess
    );


}
function onScanSuccess(code){

    document.getElementById("beep").play();

}
        // --- SIMULADOR DE ESC√ÅNER (Mockup para web) ---
        function openScanner(target) {
            Swal.fire({
                title: 'Simulaci√≥n de Esc√°ner',
                text: 'En un entorno web real usar√≠a la c√°mara con html5-qrcode. Aqu√≠ simularemos escanear la Coca Cola (7501055300075).',
                icon: 'info',
                confirmButtonText: 'Simular Escaneo'
            }).then(() => {
                if(target === 'pos') {
                    searchProduct('7501055300075');
                    document.getElementById('barcode-scanner').value = '7501055300075';
                } else {
                    document.getElementById('p-code').value = '7501055300075';
                }
            });
        }
        function closeScanner() { document.getElementById('scanner-modal').classList.add('hidden'); }

    </script>
    <script>
let html5QrCode;
let scannerTarget = null;

// Abrir esc√°ner
function openScanner(target) {
    scannerTarget = target;
    document.getElementById("scanner-modal").classList.remove("hidden");

    html5QrCode = new Html5Qrcode("reader");

    const config = {
        fps: 10,
        qrbox: { width: 250, height: 120 },
        aspectRatio: 1.7778,
        formatsToSupport: [
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.CODE_93,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ]
    };

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {

            // buscar c√°mara trasera
            let cameraId = cameras[0].id;
            cameras.forEach(cam => {
                if (cam.label.toLowerCase().includes("back") ||
                    cam.label.toLowerCase().includes("trasera")) {
                    cameraId = cam.id;
                }
            });

            html5QrCode.start(
                cameraId,
                config,
                onScanSuccess
            );

        } else {
            alert("No se encontr√≥ c√°mara");
        }
    }).catch(err => {
        console.error(err);
        alert("Error al abrir c√°mara");
    });
}
function onScanSuccess(decodedText) {

    closeScanner();

    // POS
    if (scannerTarget === "pos") {

        const input = document.getElementById("barcode-scanner");
        input.value = decodedText;
        searchProduct(decodedText);

    }

    // NUEVO PRODUCTO / STOCK
    if (scannerTarget === "stock") {

        const input = document.getElementById("p-code");
        input.value = decodedText;

        // buscar si ya existe producto
        if (typeof products !== "undefined") {

            const producto = products.find(p => p.code === decodedText);

            if (producto) {

                document.getElementById("p-name").value = producto.name;
                document.getElementById("p-cost").value = producto.cost;
                document.getElementById("p-price").value = producto.price;
                document.getElementById("p-stock").value = producto.stock;

            }

        }

    }

}

window.addEventListener("beforeunload", function(){

    localStorage.setItem("cart", JSON.stringify(cart));

});
// Cerrar esc√°ner
function closeScanner() {

    document.getElementById("scanner-modal").classList.add("hidden");

    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
        }).catch(err => {
            console.log(err);
        });
    }

}
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>

