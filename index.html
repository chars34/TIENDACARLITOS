<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Super POS - Avanzado</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome para Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- SweetAlert2 para Alertas Bonitas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- HTML5 QRCode Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden; 
        }

        .ticket-font {
            font-family: 'Space Mono', monospace;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; left: 0; top: 0;
                width: 100%; padding: 0; margin: 0;
            }
        }
    </style>
</head>
<body class="h-screen flex text-gray-800">

    <!-- ==================== PANTALLA DE LOGIN ==================== -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-[100] transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center mx-4">
            <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-4">
                <i class="fa-solid fa-store"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-1">Mini Super POS</h1>
            <p class="text-sm text-gray-500 mb-6">Ingresa tu PIN de acceso</p>
            
            <div class="space-y-4">
                <input type="password" id="login-pin" class="w-full text-center text-3xl tracking-[0.5em] font-bold p-4 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none transition-colors" placeholder="****" maxlength="6" autofocus onkeyup="if(event.key === 'Enter') attemptLogin()">
                
                <button onclick="attemptLogin()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition shadow-lg flex justify-center items-center gap-2">
                    Ingresar <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>

            <div class="mt-8 text-xs text-gray-400 bg-gray-50 p-3 rounded-lg text-left">
                <p class="font-bold text-gray-500 mb-1"><i class="fa-solid fa-circle-info"></i> PINs por defecto:</p>
                <p>Dueño (Acceso Total): <span class="font-mono bg-gray-200 px-1 rounded text-gray-700 font-bold">1234</span></p>
                <p>Empleado (Solo Ventas): <span class="font-mono bg-gray-200 px-1 rounded text-gray-700 font-bold">1111</span></p>
            </div>
        </div>
    </div>

    <!-- ==================== APLICACIÓN PRINCIPAL ==================== -->
    <div id="app-container" class="hidden flex-col md:flex-row w-full h-full">
        
        <!-- BARRA LATERAL / NAVEGACIÓN -->
        <nav class="bg-red-700 text-white w-full md:w-20 lg:w-64 flex md:flex-col justify-between md:justify-start shadow-xl z-20 shrink-0">
            <div class="p-4 hidden lg:block text-center border-b border-red-800">
                <h1 class="text-2xl font-bold truncate"><i class="fa-solid fa-store mr-2"></i>Mini Super</h1>
                <p id="clock" class="text-xs text-red-200 mt-1"></p>
                <div class="mt-2 text-xs bg-red-800/50 py-1 px-2 rounded-full inline-block border border-red-500/30">
                    <i class="fa-solid fa-user mr-1"></i> <span id="current-user-badge">Dueño</span>
                </div>
            </div>
            
            <div class="flex md:flex-col w-full overflow-x-auto no-scrollbar md:mt-4 h-full">
                <!-- Pestañas -->
                <button onclick="switchTab('pos')" id="tab-btn-pos" class="flex-1 md:flex-none p-4 text-center lg:text-left hover:bg-red-600 transition-colors bg-red-800 border-l-4 border-white font-medium flex flex-col lg:flex-row items-center gap-2">
                    <i class="fa-solid fa-cash-register text-xl lg:text-lg"></i>
                    <span class="text-xs lg:text-base hidden sm:block">Ventas</span>
                </button>
                
                <!-- Pestañas restringidas para empleados -->
                <button onclick="switchTab('inventory')" id="tab-btn-inventory" class="admin-only flex-1 md:flex-none p-4 text-center lg:text-left hover:bg-red-600 transition-colors border-l-4 border-transparent text-red-100 flex flex-col lg:flex-row items-center gap-2">
                    <i class="fa-solid fa-boxes-stacked text-xl lg:text-lg"></i>
                    <span class="text-xs lg:text-base hidden sm:block">Inventario</span>
                </button>
                <button onclick="switchTab('reports')" id="tab-btn-reports" class="admin-only flex-1 md:flex-none p-4 text-center lg:text-left hover:bg-red-600 transition-colors border-l-4 border-transparent text-red-100 flex flex-col lg:flex-row items-center gap-2">
                    <i class="fa-solid fa-chart-line text-xl lg:text-lg"></i>
                    <span class="text-xs lg:text-base hidden sm:block">Reportes</span>
                </button>
                <button onclick="switchTab('settings')" id="tab-btn-settings" class="admin-only flex-1 md:flex-none p-4 text-center lg:text-left hover:bg-red-600 transition-colors border-l-4 border-transparent text-red-100 flex flex-col lg:flex-row items-center gap-2">
                    <i class="fa-solid fa-cog text-xl lg:text-lg"></i>
                    <span class="text-xs lg:text-base hidden sm:block">Ajustes</span>
                </button>

                <!-- Botón Salir -->
                <button onclick="logout()" class="flex-1 md:flex-none p-4 text-center lg:text-left hover:bg-red-800 bg-red-900 transition-colors border-l-4 border-transparent text-red-100 flex flex-col lg:flex-row items-center gap-2 md:mt-auto">
                    <i class="fa-solid fa-sign-out-alt text-xl lg:text-lg"></i>
                    <span class="text-xs lg:text-base hidden sm:block">Salir</span>
                </button>
            </div>
        </nav>

        <!-- ÁREA PRINCIPAL -->
        <main class="flex-1 relative overflow-hidden bg-gray-100">
            
            <!-- PESTAÑA: PUNTO DE VENTA (POS) -->
            <div id="tab-pos" class="tab-content active h-full">
                <div class="flex flex-col lg:flex-row h-full">
                    
                    <!-- Panel Izquierdo: Buscador y Productos Rápidos -->
                    <div class="w-full lg:w-7/12 p-4 flex flex-col h-[50vh] lg:h-full border-r border-gray-200 bg-white shadow-sm z-10">
                        <!-- Buscador / Escáner -->
                        <div class="mb-4">
                            <label class="text-sm text-gray-500 font-semibold mb-1 block">Código de Barras</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <i class="fa-solid fa-barcode absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="pos-barcode" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-500 text-lg transition-colors" placeholder="Escanea o escribe código + Enter">
                                </div>
                                <button onclick="openScannerModal('pos')" class="bg-gray-800 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                                    <i class="fa-solid fa-camera"></i>
                                </button>
                                <button onclick="searchAndAddToCart()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors shadow-md font-medium">
                                    Buscar
                                </button>
                            </div>
                        </div>

                        <!-- Botones de Productos Rápidos -->
                        <div class="flex-1 overflow-y-auto no-scrollbar pb-20 lg:pb-0">
                            <h3 class="text-sm text-gray-500 font-semibold mb-3"><i class="fa-solid fa-bolt text-yellow-500 mr-1"></i> Productos Frecuentes</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3" id="quick-products-grid">
                                <!-- Se llena por JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Panel Derecho: Carrito de Compras -->
                    <div class="w-full lg:w-5/12 bg-gray-50 flex flex-col h-[50vh] lg:h-full relative shadow-inner">
                        <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
                            <h2 class="text-lg font-bold text-gray-700">Ticket Actual</h2>
                            <button onclick="clearCart()" class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors text-sm font-medium">
                                <i class="fa-solid fa-trash mr-1"></i> Vaciar
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="cart-list">
                            <div class="text-center text-gray-400 mt-10">
                                <i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-50"></i>
                                <p>El carrito está vacío</p>
                            </div>
                        </div>

                        <div class="bg-white p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10">
                            <div class="flex justify-between items-center mb-2 text-gray-600">
                                <span class="font-medium">Artículos:</span>
                                <span id="cart-items-count" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between items-center mb-4 text-2xl font-bold text-gray-800">
                                <span>TOTAL:</span>
                                <span class="text-red-600">$<span id="cart-total">0.00</span></span>
                            </div>
                            <button onclick="openPaymentModal()" id="btn-pay" disabled class="w-full bg-green-500 disabled:bg-gray-300 text-white font-bold text-xl py-4 rounded-xl shadow-lg hover:bg-green-600 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-hand-holding-dollar"></i> COBRAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTAÑA: INVENTARIO (Solo Admin) -->
            <div id="tab-inventory" class="tab-content h-full p-4 md:p-6 overflow-y-auto admin-only-content">
                <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-[calc(100vh-2rem)]">
                    <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-boxes-stacked mr-2 text-red-600"></i>Gestión de Inventario</h2>
                        <button onclick="openProductModal()" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 shadow-md transition-colors flex items-center gap-2 font-medium">
                            <i class="fa-solid fa-plus"></i> Nuevo Producto
                        </button>
                    </div>
                    
                    <div class="p-4 border-b border-gray-100">
                        <div class="relative max-w-md">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="inventory-search" onkeyup="renderInventory()" placeholder="Buscar producto por nombre o código..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-red-500">
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto">
                        <table class="min-w-full text-left border-collapse">
                            <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="py-3 px-4 font-semibold text-sm text-gray-600 border-b">Código</th>
                                    <th class="py-3 px-4 font-semibold text-sm text-gray-600 border-b">Descripción</th>
                                    <th class="py-3 px-4 font-semibold text-sm text-gray-600 border-b text-right">Precio</th>
                                    <th class="py-3 px-4 font-semibold text-sm text-gray-600 border-b text-center">Stock</th>
                                    <th class="py-3 px-4 font-semibold text-sm text-gray-600 border-b text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-tbody" class="divide-y divide-gray-100">
                                <!-- Filas de inventario -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PESTAÑA: REPORTES (Solo Admin) -->
            <div id="tab-reports" class="tab-content h-full p-4 md:p-6 overflow-y-auto admin-only-content">
                <div class="max-w-5xl mx-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <h3 class="text-gray-500 text-sm font-semibold uppercase">Ventas de Hoy</h3>
                            <p class="text-3xl font-bold text-gray-800 mt-2">$<span id="report-total-today">0.00</span></p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <h3 class="text-gray-500 text-sm font-semibold uppercase">Tickets Generados</h3>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="report-tickets-count">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-500">
                            <h3 class="text-gray-500 text-sm font-semibold uppercase">Productos Bajos en Stock</h3>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="report-low-stock">0</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-receipt mr-2 text-gray-500"></i>Últimos Tickets</h2>
                            <button onclick="clearSalesHistory()" class="text-sm text-red-500 hover:text-red-700 font-medium">Borrar Historial</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left border-collapse">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-2 px-4 font-semibold text-sm text-gray-500 border-b">ID Ticket</th>
                                        <th class="py-2 px-4 font-semibold text-sm text-gray-500 border-b">Fecha/Hora</th>
                                        <th class="py-2 px-4 font-semibold text-sm text-gray-500 border-b text-center">Atendido por</th>
                                        <th class="py-2 px-4 font-semibold text-sm text-gray-500 border-b text-right">Total</th>
                                        <th class="py-2 px-4 font-semibold text-sm text-gray-500 border-b text-center">Ticket</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-history-tbody" class="divide-y divide-gray-100 text-sm">
                                    <!-- Historial -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTAÑA: AJUSTES (Solo Admin) -->
            <div id="tab-settings" class="tab-content h-full p-4 md:p-6 overflow-y-auto admin-only-content">
                 <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6">
                     <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fa-solid fa-cogs mr-2 text-gray-500"></i>Configuración del Sistema</h2>
                     
                     <div class="space-y-6">
                         <!-- Negocio -->
                         <div class="border-b pb-4">
                             <h3 class="text-lg font-semibold mb-3">Datos del Negocio</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label class="block text-sm text-gray-600 mb-1">Nombre de la Tienda</label>
                                     <input type="text" id="config-store-name" class="w-full border rounded p-2 focus:border-red-500 outline-none" onchange="saveConfig()">
                                 </div>
                                 <div>
                                     <label class="block text-sm text-gray-600 mb-1">Mensaje al pie del ticket</label>
                                     <input type="text" id="config-ticket-msg" class="w-full border rounded p-2 focus:border-red-500 outline-none" onchange="saveConfig()">
                                 </div>
                             </div>
                         </div>

                         <!-- Seguridad -->
                         <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-3"><i class="fa-solid fa-shield-halved text-gray-500 mr-2"></i>Seguridad y Accesos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">PIN de Dueño (Admin)</label>
                                    <div class="relative">
                                        <input type="password" id="config-admin-pin" class="w-full border rounded p-2 pl-9 focus:border-red-500 outline-none tracking-widest" onchange="saveConfig()">
                                        <i class="fa-solid fa-user-tie absolute left-3 top-3 text-gray-400"></i>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Acceso a todas las pestañas.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">PIN de Empleado</label>
                                    <div class="relative">
                                        <input type="password" id="config-emp-pin" class="w-full border rounded p-2 pl-9 focus:border-red-500 outline-none tracking-widest" onchange="saveConfig()">
                                        <i class="fa-solid fa-user absolute left-3 top-3 text-gray-400"></i>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Solo puede realizar Ventas.</p>
                                </div>
                            </div>
                        </div>

                         <!-- Peligro -->
                         <div class="pt-2">
                            <h3 class="text-lg font-semibold mb-2 text-red-600">Zona de Peligro</h3>
                            <p class="text-sm text-gray-500 mb-3">Estas acciones no se pueden deshacer.</p>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="factoryReset()" class="bg-red-100 text-red-700 px-4 py-2 rounded border border-red-300 hover:bg-red-200 transition font-medium text-sm">
                                    <i class="fa-solid fa-skull mr-1"></i> Borrar Todo (Reset)
                                </button>
                                <button onclick="loadSampleData()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded border border-blue-300 hover:bg-blue-200 transition font-medium text-sm">
                                    <i class="fa-solid fa-database mr-1"></i> Cargar Datos de Prueba
                                </button>
                            </div>
                         </div>
                     </div>
                 </div>
            </div>

        </main>
    </div>

    <!-- ==================== MODALES (Mismos que la versión anterior) ==================== -->
    
    <!-- Modal Agregar/Editar Producto -->
    <div id="modal-product" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-800" id="modal-product-title">Nuevo Producto</h3>
                <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Código de Barras *</label>
                    <div class="flex gap-2">
                        <input type="text" id="prod-code" class="w-full border border-gray-300 rounded-lg p-2 focus:border-red-500 focus:outline-none bg-gray-50">
                        <button onclick="openScannerModal('inventory')" class="bg-gray-200 px-3 rounded-lg hover:bg-gray-300"><i class="fa-solid fa-camera"></i></button>
                        <button onclick="generateRandomCode()" class="bg-gray-200 px-3 rounded-lg hover:bg-gray-300 text-xs font-bold" title="Generar código interno">GEN</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Descripción / Nombre *</label>
                    <input type="text" id="prod-name" class="w-full border border-gray-300 rounded-lg p-2 focus:border-red-500 focus:outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Precio Venta ($) *</label>
                        <input type="number" step="0.5" id="prod-price" class="w-full border border-gray-300 rounded-lg p-2 focus:border-red-500 focus:outline-none text-right">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-600 mb-1">Stock Actual *</label>
                        <input type="number" id="prod-stock" class="w-full border border-gray-300 rounded-lg p-2 focus:border-red-500 focus:outline-none text-right">
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="prod-quick" class="w-4 h-4 text-red-600 rounded">
                    <label for="prod-quick" class="text-sm text-gray-600">Mostrar en Productos Rápidos (POS)</label>
                </div>
            </div>
            <div class="p-5 border-t border-gray-100 flex justify-end gap-3 bg-gray-50 rounded-b-xl">
                <button onclick="closeProductModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition font-medium">Cancelar</button>
                <button onclick="saveProduct()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cobro -->
    <div id="modal-payment" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
            <div class="bg-gray-800 text-white p-6 text-center">
                <p class="text-gray-300 text-sm uppercase tracking-wider mb-1">Total a Cobrar</p>
                <h2 class="text-4xl font-bold">$<span id="pay-total-amount">0.00</span></h2>
            </div>
            <div class="p-6">
                <label class="block text-sm font-semibold text-gray-600 mb-2 text-center">¿Con cuánto paga el cliente?</label>
                <div class="relative mb-6">
                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold text-xl">$</span>
                    <input type="number" id="pay-cash-received" onkeyup="calculateChange()" class="w-full pl-10 pr-4 py-4 text-2xl text-center border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none font-bold text-gray-800" placeholder="0.00">
                </div>
                
                <div class="flex justify-center gap-2 mb-6">
                    <button onclick="setQuickCash(50)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold text-gray-700 border">$50</button>
                    <button onclick="setQuickCash(100)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold text-gray-700 border">$100</button>
                    <button onclick="setQuickCash(200)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold text-gray-700 border">$200</button>
                    <button onclick="setQuickCash(500)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold text-gray-700 border">$500</button>
                    <button onclick="setExactCash()" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm font-bold border border-blue-300">Exacto</button>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border mb-6 text-center">
                    <p class="text-sm text-gray-500 font-semibold">Cambio a devolver:</p>
                    <p id="pay-change-amount" class="text-3xl font-bold text-gray-400 mt-1">$0.00</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="closePaymentModal()" class="flex-1 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold transition">Cancelar</button>
                    <button onclick="finalizeSale()" id="btn-confirm-pay" disabled class="flex-1 py-3 bg-green-500 disabled:bg-gray-300 text-white rounded-xl font-bold shadow-md hover:bg-green-600 transition">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Escáner -->
    <div id="modal-scanner" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-xl overflow-hidden shadow-2xl relative">
            <div class="p-3 bg-gray-800 text-white flex justify-between items-center">
                <h3 class="font-bold">Escanear Código</h3>
                <button onclick="closeScannerModal()" class="text-gray-300 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="reader" class="w-full h-64 bg-black"></div>
            <div class="p-4 text-center text-sm text-gray-600 bg-gray-50">
                Apunta la cámara al código de barras
            </div>
        </div>
    </div>

    <!-- ÁREA DE IMPRESIÓN TICKET -->
    <div id="print-area" class="hidden ticket-font bg-white text-black p-2 text-sm max-w-[58mm] mx-auto">
        <div class="text-center mb-4">
            <h2 id="print-store-name" class="font-bold text-lg leading-tight uppercase">MINI SUPER</h2>
            <p class="text-xs mt-1">Ticket de Venta</p>
            <p class="text-xs" id="print-date"></p>
            <p class="text-xs">Ticket #: <span id="print-ticket-id"></span></p>
            <p class="text-xs mt-1">Le atendió: <span id="print-cashier"></span></p>
        </div>
        
        <div class="border-t border-b border-black border-dashed py-2 mb-2">
            <table class="w-full text-xs">
                <thead>
                    <tr class="text-left border-b border-black">
                        <th class="pb-1 w-8">Cant</th>
                        <th class="pb-1">Desc</th>
                        <th class="pb-1 text-right">Imp</th>
                    </tr>
                </thead>
                <tbody id="print-items"></tbody>
            </table>
        </div>
        
        <div class="text-right text-xs space-y-1 mb-4 font-bold">
            <p>TOTAL: $<span id="print-total"></span></p>
            <p class="text-[10px] font-normal">Efectivo: $<span id="print-cash"></span></p>
            <p class="text-[10px] font-normal">Cambio: $<span id="print-change"></span></p>
        </div>
        
        <div class="text-center text-xs border-t border-black border-dashed pt-2">
            <p id="print-msg">¡Gracias por su compra!</p>
            <p class="mt-2 text-[9px]">Vuelva pronto</p>
        </div>
    </div>

    <!-- ==================== LÓGICA JAVASCRIPT ==================== -->
    <script>
        // --- ESTADO Y CONFIGURACIÓN ---
        let state = {
            inventory: JSON.parse(localStorage.getItem('ms_inventory')) || [],
            sales: JSON.parse(localStorage.getItem('ms_sales')) || [],
            cart: [],
            config: JSON.parse(localStorage.getItem('ms_config')) || {
                storeName: "Mini Super Carlitos",
                ticketMsg: "¡Gracias por su preferencia!",
                adminPin: "1234",
                empPin: "1111"
            },
            currentTab: 'pos',
            scannerInstance: null,
            scannerContext: null,
            currentUserRole: null // 'admin' o 'employee'
        };

        let currentSaleTotal = 0;
        let cashReceived = 0;

        window.onload = () => {
            initClock();
            
            // Atajo de teclado POS
            document.getElementById('pos-barcode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchAndAddToCart();
            });

            // Verificar si hay sesión activa temporal (Session Storage)
            const savedSession = sessionStorage.getItem('ms_logged_role');
            if (savedSession) {
                activateSession(savedSession);
            }
        };

        // --- SISTEMA DE LOGIN Y ROLES ---

        function attemptLogin() {
            const input = document.getElementById('login-pin');
            const pin = input.value;
            
            if (pin === state.config.adminPin) {
                activateSession('admin');
            } else if (pin === state.config.empPin) {
                activateSession('employee');
            } else {
                input.value = '';
                Swal.fire({
                    icon: 'error',
                    title: 'PIN Incorrecto',
                    text: 'El código ingresado no es válido.',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }

        function activateSession(role) {
            state.currentUserRole = role;
            sessionStorage.setItem('ms_logged_role', role); // Guardar sesión temporalmente
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            
            // Actualizar Badge en UI
            const badge = document.getElementById('current-user-badge');
            if (role === 'admin') {
                badge.innerText = 'Dueño';
                badge.parentElement.classList.replace('bg-gray-600', 'bg-red-800');
            } else {
                badge.innerText = 'Empleado';
                badge.parentElement.classList.replace('bg-red-800', 'bg-gray-600');
            }

            applyRolePermissions();
            
            // Inicializar datos
            applyConfig();
            renderQuickProducts();
            switchTab('pos');
        }

        function applyRolePermissions() {
            const adminElements = document.querySelectorAll('.admin-only');
            const adminContents = document.querySelectorAll('.admin-only-content');

            if (state.currentUserRole === 'employee') {
                // Ocultar pestañas de admin
                adminElements.forEach(el => el.classList.add('hidden'));
                adminContents.forEach(el => el.classList.add('hidden'));
            } else {
                // Mostrar pestañas de admin (Dueño)
                adminElements.forEach(el => {
                    el.classList.remove('hidden');
                    el.classList.add('flex'); // Recuperar estilo flex
                });
                adminContents.forEach(el => el.classList.remove('hidden'));
            }
        }

        function logout() {
            state.currentUserRole = null;
            sessionStorage.removeItem('ms_logged_role');
            state.cart = []; // Vaciar carrito por seguridad
            updateCartUI();
            
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('flex');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-pin').value = '';
            
            setTimeout(() => document.getElementById('login-pin').focus(), 100);
        }

        // --- NAVEGACIÓN ---
        function switchTab(tabId) {
            // Validar permiso
            if (state.currentUserRole === 'employee' && tabId !== 'pos') {
                toast('Acceso Denegado', 'error');
                return;
            }

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('[id^="tab-btn-"]').forEach(el => {
                el.classList.remove('bg-red-800', 'border-white', 'text-white');
                el.classList.add('border-transparent', 'text-red-100');
            });

            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            const btn = document.getElementById(`tab-btn-${tabId}`);
            if(btn) {
                btn.classList.add('bg-red-800', 'border-white', 'text-white');
                btn.classList.remove('border-transparent', 'text-red-100');
            }

            state.currentTab = tabId;

            if(tabId === 'pos') document.getElementById('pos-barcode').focus();
            else if(tabId === 'inventory') renderInventory();
            else if(tabId === 'reports') renderReports();
            else if(tabId === 'settings') loadSettingsToUI();
        }

        // --- POS (PUNTO DE VENTA) ---
        function searchAndAddToCart(scannedCode = null) {
            const inputEl = document.getElementById('pos-barcode');
            const code = scannedCode || inputEl.value.trim();
            if(!code) return;

            const product = state.inventory.find(p => p.code === code);
            
            if(product) {
                addToCart(product);
                inputEl.value = ''; 
            } else {
                Swal.fire({ icon: 'error', title: 'No encontrado', text: `Código no registrado.`, timer: 1500, showConfirmButton: false });
                inputEl.select();
            }
            inputEl.focus();
        }

        function addToCart(product) {
            if(product.stock <= 0) {
                Swal.fire('Sin Stock', `El producto está agotado.`, 'warning');
                return;
            }

            const existing = state.cart.find(item => item.code === product.code);
            if(existing) {
                if(existing.qty < product.stock) existing.qty++;
                else { toast('Stock máximo alcanzado', 'warning'); return; }
            } else {
                state.cart.push({ ...product, qty: 1, maxStock: product.stock });
            }
            
            updateCartUI();
            toast(`${product.name} agregado`);
        }

        function updateCartQty(index, delta) {
            const item = state.cart[index];
            const newQty = item.qty + delta;

            if(newQty > 0 && newQty <= item.maxStock) item.qty = newQty;
            else if (newQty === 0) state.cart.splice(index, 1);
            
            updateCartUI();
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            updateCartUI();
        }

        function clearCart() {
            if(state.cart.length === 0) return;
            Swal.fire({
                title: '¿Vaciar carrito?', icon: 'warning', showCancelButton: true,
                confirmButtonColor: '#d33', confirmButtonText: 'Sí, vaciar', cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    state.cart = []; updateCartUI();
                    document.getElementById('pos-barcode').focus();
                }
            });
        }

        function updateCartUI() {
            const listEl = document.getElementById('cart-list');
            let total = 0, itemsCount = 0;

            if(state.cart.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-50"></i><p>El carrito está vacío</p></div>`;
                document.getElementById('cart-total').innerText = "0.00";
                document.getElementById('cart-items-count').innerText = "0";
                document.getElementById('btn-pay').disabled = true;
                return;
            }

            listEl.innerHTML = '';
            [...state.cart].reverse().forEach((item, revIndex) => {
                const index = state.cart.length - 1 - revIndex; 
                const subtotal = item.price * item.qty;
                total += subtotal; itemsCount += item.qty;

                listEl.innerHTML += `
                    <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex flex-col gap-2 relative group">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 text-sm leading-tight pr-6">${item.name}</h4>
                            <span class="font-bold text-red-600">$${subtotal.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">$${item.price.toFixed(2)} c/u</span>
                            <div class="flex items-center bg-gray-100 rounded-lg border border-gray-200">
                                <button onclick="updateCartQty(${index}, -1)" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 font-bold">-</button>
                                <span class="px-3 font-semibold text-sm w-8 text-center">${item.qty}</span>
                                <button onclick="updateCartQty(${index}, 1)" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 font-bold">+</button>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${index})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-times"></i></button>
                    </div>`;
            });

            currentSaleTotal = total;
            document.getElementById('cart-total').innerText = total.toFixed(2);
            document.getElementById('cart-items-count').innerText = itemsCount;
            document.getElementById('btn-pay').disabled = false;
        }

        function renderQuickProducts() {
            const grid = document.getElementById('quick-products-grid');
            grid.innerHTML = '';
            const quickItems = state.inventory.filter(p => p.isQuick);
            
            if(quickItems.length === 0) {
                grid.innerHTML = `<p class="text-xs text-gray-400 col-span-full text-center py-4">No hay productos configurados.</p>`;
                return;
            }

            quickItems.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'bg-white border border-gray-200 p-3 rounded-xl shadow-sm hover:border-red-500 transition text-center flex flex-col items-center justify-center min-h-[80px]';
                btn.onclick = () => addToCart(p);
                btn.innerHTML = `
                    <span class="font-semibold text-gray-800 text-sm leading-tight line-clamp-2">${p.name}</span>
                    <span class="text-red-600 font-bold text-xs">$${parseFloat(p.price).toFixed(2)}</span>`;
                grid.appendChild(btn);
            });
        }

        // --- COBRO Y TICKET ---
        function openPaymentModal() {
            if(state.cart.length === 0) return;
            document.getElementById('pay-total-amount').innerText = currentSaleTotal.toFixed(2);
            document.getElementById('pay-cash-received').value = '';
            document.getElementById('pay-change-amount').innerText = '$0.00';
            document.getElementById('pay-change-amount').className = "text-3xl font-bold text-gray-400 mt-1";
            document.getElementById('btn-confirm-pay').disabled = true;
            document.getElementById('modal-payment').classList.remove('hidden');
            setTimeout(() => document.getElementById('pay-cash-received').focus(), 100);
        }

        function closePaymentModal() {
            document.getElementById('modal-payment').classList.add('hidden');
            document.getElementById('pos-barcode').focus();
        }

        function setQuickCash(amount) {
            const input = document.getElementById('pay-cash-received');
            let current = parseFloat(input.value) || 0;
            input.value = input.value === '' ? amount : current + amount;
            calculateChange();
        }

        function setExactCash() {
            document.getElementById('pay-cash-received').value = currentSaleTotal;
            calculateChange();
        }

        function calculateChange() {
            cashReceived = parseFloat(document.getElementById('pay-cash-received').value) || 0;
            const change = cashReceived - currentSaleTotal;
            const changeEl = document.getElementById('pay-change-amount');
            const btnConfirm = document.getElementById('btn-confirm-pay');

            if(cashReceived >= currentSaleTotal) {
                changeEl.innerText = `$${change.toFixed(2)}`;
                changeEl.className = "text-3xl font-bold text-green-600 mt-1";
                btnConfirm.disabled = false;
            } else {
                changeEl.innerText = 'Falta dinero';
                changeEl.className = "text-xl font-bold text-red-500 mt-1";
                btnConfirm.disabled = true;
            }
        }

        function finalizeSale() {
            if(cashReceived < currentSaleTotal) return;
            const change = cashReceived - currentSaleTotal;
            const ticketId = 'TKT-' + Date.now().toString().slice(-6);
            
            const saleRecord = {
                id: ticketId,
                date: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(state.cart)),
                total: currentSaleTotal, cash: cashReceived, change: change,
                cashier: state.currentUserRole === 'admin' ? 'Dueño' : 'Empleado'
            };

            state.cart.forEach(cartItem => {
                const prod = state.inventory.find(p => p.code === cartItem.code);
                if(prod) prod.stock -= cartItem.qty;
            });

            state.sales.push(saleRecord);
            saveData();
            renderQuickProducts(); 
            preparePrintTicket(saleRecord);
            
            closePaymentModal();
            state.cart = []; updateCartUI();

            Swal.fire({
                title: 'Venta Completada',
                html: `Cambio a devolver:<br><span class="text-4xl font-bold text-green-600 mt-2 block">$${change.toFixed(2)}</span>`,
                icon: 'success', showCancelButton: true, confirmButtonColor: '#10b981',
                confirmButtonText: '<i class="fa-solid fa-print"></i> Imprimir', cancelButtonText: 'Nueva Venta'
            }).then((result) => {
                if (result.isConfirmed) window.print();
                document.getElementById('pos-barcode').focus();
            });
        }

        function preparePrintTicket(sale) {
            document.getElementById('print-store-name').innerText = state.config.storeName;
            document.getElementById('print-msg').innerText = state.config.ticketMsg;
            document.getElementById('print-date').innerText = new Date(sale.date).toLocaleString('es-MX');
            document.getElementById('print-ticket-id').innerText = sale.id;
            document.getElementById('print-cashier').innerText = sale.cashier;
            
            const tbody = document.getElementById('print-items');
            tbody.innerHTML = '';
            sale.items.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td class="pb-1 align-top">${item.qty}</td>
                        <td class="pb-1 align-top leading-tight">${item.name}<br><span class="text-[10px] text-gray-500">$${item.price.toFixed(2)}</span></td>
                        <td class="pb-1 align-top text-right">$${(item.qty * item.price).toFixed(2)}</td>
                    </tr>`;
            });
            document.getElementById('print-total').innerText = sale.total.toFixed(2);
            document.getElementById('print-cash').innerText = sale.cash.toFixed(2);
            document.getElementById('print-change').innerText = sale.change.toFixed(2);
        }

        // --- INVENTARIO, REPORTES Y AJUSTES (Resto de funciones) ---
        // (La lógica es idéntica a la versión anterior, solo se ajustó para proteger accesos)
        
        let editingCode = null;

        function renderInventory() {
            if (state.currentUserRole !== 'admin') return;
            const term = document.getElementById('inventory-search').value.toLowerCase();
            const tbody = document.getElementById('inventory-tbody');
            tbody.innerHTML = '';

            const filtered = state.inventory.filter(p => p.name.toLowerCase().includes(term) || p.code.toLowerCase().includes(term));
            if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">No hay productos.</td></tr>`; return; }

            filtered.forEach(p => {
                const stockClass = p.stock <= 5 ? 'text-red-600 font-bold bg-red-50 py-1 px-2 rounded-full' : 'text-gray-700';
                const quickIcon = p.isQuick ? '<i class="fa-solid fa-bolt text-yellow-500 ml-1"></i>' : '';
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-50">
                        <td class="py-3 px-4 text-sm font-mono">${p.code}</td>
                        <td class="py-3 px-4 text-sm">${p.name} ${quickIcon}</td>
                        <td class="py-3 px-4 text-sm text-right">$${parseFloat(p.price).toFixed(2)}</td>
                        <td class="py-3 px-4 text-sm text-center"><span class="${stockClass}">${p.stock}</span></td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="editProduct('${p.code}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteProduct('${p.code}')" class="text-red-500 hover:text-red-700 p-2"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function openProductModal() {
            editingCode = null;
            document.getElementById('modal-product-title').innerText = 'Nuevo Producto';
            ['prod-code', 'prod-name', 'prod-price', 'prod-stock'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('prod-code').disabled = false;
            document.getElementById('prod-quick').checked = false;
            document.getElementById('modal-product').classList.remove('hidden');
        }

        function closeProductModal() { document.getElementById('modal-product').classList.add('hidden'); }
        function generateRandomCode() { document.getElementById('prod-code').value = 'INT-' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0'); }

        function saveProduct() {
            const code = document.getElementById('prod-code').value.trim();
            const name = document.getElementById('prod-name').value.trim();
            const price = parseFloat(document.getElementById('prod-price').value);
            const stock = parseInt(document.getElementById('prod-stock').value);
            const isQuick = document.getElementById('prod-quick').checked;

            if(!code || !name || isNaN(price) || isNaN(stock)) { Swal.fire('Error', 'Llena todos los campos.', 'error'); return; }

            if(editingCode) {
                const idx = state.inventory.findIndex(p => p.code === editingCode);
                if(idx !== -1) state.inventory[idx] = { code, name, price, stock, isQuick };
            } else {
                if(state.inventory.find(p => p.code === code)) { Swal.fire('Error', 'El código ya existe.', 'error'); return; }
                state.inventory.push({ code, name, price, stock, isQuick });
            }

            saveData(); renderInventory(); renderQuickProducts(); closeProductModal(); toast('Producto guardado');
        }

        function editProduct(code) {
            const p = state.inventory.find(p => p.code === code);
            if(!p) return;
            editingCode = code;
            document.getElementById('modal-product-title').innerText = 'Editar Producto';
            document.getElementById('prod-code').value = p.code; document.getElementById('prod-code').disabled = true;
            document.getElementById('prod-name').value = p.name;
            document.getElementById('prod-price').value = p.price;
            document.getElementById('prod-stock').value = p.stock;
            document.getElementById('prod-quick').checked = p.isQuick || false;
            document.getElementById('modal-product').classList.remove('hidden');
        }

        function deleteProduct(code) {
            Swal.fire({ title: '¿Eliminar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sí' })
            .then((res) => {
                if(res.isConfirmed) {
                    state.inventory = state.inventory.filter(p => p.code !== code);
                    saveData(); renderInventory(); renderQuickProducts(); toast('Eliminado');
                }
            });
        }

        function renderReports() {
            if (state.currentUserRole !== 'admin') return;
            const todayStr = new Date().toDateString();
            const todaySales = state.sales.filter(s => new Date(s.date).toDateString() === todayStr);
            
            document.getElementById('report-total-today').innerText = todaySales.reduce((s, i) => s + i.total, 0).toFixed(2);
            document.getElementById('report-tickets-count').innerText = todaySales.length;
            document.getElementById('report-low-stock').innerText = state.inventory.filter(p => p.stock <= 5).length;

            const tbody = document.getElementById('sales-history-tbody');
            tbody.innerHTML = '';
            const recentSales = [...state.sales].reverse().slice(0, 50);

            if(recentSales.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-6">No hay ventas.</td></tr>`; return; }

            recentSales.forEach(sale => {
                const dateObj = new Date(sale.date);
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="py-3 px-4 font-mono text-xs">${sale.id}</td>
                        <td class="py-3 px-4 text-xs">${dateObj.toLocaleDateString()} ${dateObj.toLocaleTimeString()}</td>
                        <td class="py-3 px-4 text-xs text-center">${sale.cashier || 'Desconocido'}</td>
                        <td class="py-3 px-4 text-right font-bold text-green-600">$${sale.total.toFixed(2)}</td>
                        <td class="py-3 px-4 text-center">
                            <button onclick='reprintTicket(${JSON.stringify(sale)})' class="text-blue-500 bg-blue-50 p-1 rounded"><i class="fa-solid fa-print"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function reprintTicket(sale) { preparePrintTicket(sale); window.print(); }
        
        function clearSalesHistory() {
            Swal.fire({ title: '¿Borrar historial?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sí, borrar' })
            .then((res) => {
                if (res.isConfirmed) { state.sales = []; saveData(); renderReports(); toast('Borrado'); }
            });
        }

        function loadSettingsToUI() {
            document.getElementById('config-store-name').value = state.config.storeName;
            document.getElementById('config-ticket-msg').value = state.config.ticketMsg;
            document.getElementById('config-admin-pin').value = state.config.adminPin;
            document.getElementById('config-emp-pin').value = state.config.empPin;
        }

        function applyConfig() { /* Funciones decorativas aplicadas directamente al imprimir */ }

        function saveConfig() {
            state.config.storeName = document.getElementById('config-store-name').value;
            state.config.ticketMsg = document.getElementById('config-ticket-msg').value;
            state.config.adminPin = document.getElementById('config-admin-pin').value || "1234";
            state.config.empPin = document.getElementById('config-emp-pin').value || "1111";
            saveData();
            toast('Configuración guardada');
        }

        function saveData() {
            localStorage.setItem('ms_inventory', JSON.stringify(state.inventory));
            localStorage.setItem('ms_sales', JSON.stringify(state.sales));
            localStorage.setItem('ms_config', JSON.stringify(state.config));
        }

        function factoryReset() {
            Swal.fire({ title: 'PELIGRO: ¿Reset?', icon: 'error', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sí, borrar todo' })
            .then((res) => { if (res.isConfirmed) { localStorage.clear(); sessionStorage.clear(); location.reload(); } });
        }

        function loadSampleData() {
            state.inventory = [
                { code: "7501055310883", name: "Coca Cola Regular 600ml", price: 18.50, stock: 24, isQuick: true },
                { code: "7501000153066", name: "Pan Blanco Bimbo Grande", price: 45.00, stock: 10, isQuick: true },
                { code: "7501011115664", name: "Sabritas Sal Original 42g", price: 16.00, stock: 15, isQuick: true },
                { code: "INT-001", name: "Bolsa de Hielo 5kg", price: 35.00, stock: 8, isQuick: true }
            ];
            saveData(); renderInventory(); renderQuickProducts();
            Swal.fire('Éxito', 'Datos de prueba cargados.', 'success');
        }

        function initClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = `${now.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric' })} | ${now.toLocaleTimeString('es-MX')}`;
            }, 1000);
        }

        // --- SCANNER DE CÁMARA ---
        function openScannerModal(context) {
            state.scannerContext = context;
            document.getElementById('modal-scanner').classList.remove('hidden');
            if(!state.scannerInstance) state.scannerInstance = new Html5Qrcode("reader");
            
            state.scannerInstance.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 100 } }, 
                onScanSuccess, onScanFailure).catch(err => {
                Swal.fire('Error', 'No se pudo iniciar la cámara.', 'error'); closeScannerModal();
            });
        }

        function closeScannerModal() {
            document.getElementById('modal-scanner').classList.add('hidden');
            if(state.scannerInstance) state.scannerInstance.stop().catch(e => console.log(e));
        }

        function onScanSuccess(decodedText) {
            closeScannerModal();
            try { const a = new (window.AudioContext || window.webkitAudioContext)(); const o = a.createOscillator(); const g = a.createGain(); o.type = 'sine'; o.frequency.value = 800; g.gain.setValueAtTime(0.1, a.currentTime); o.connect(g); g.connect(a.destination); o.start(); setTimeout(() => o.stop(), 100); } catch(e){}
            if(state.scannerContext === 'pos') searchAndAddToCart(decodedText);
            else if (state.scannerContext === 'inventory') document.getElementById('prod-code').value = decodedText;
        }

        function onScanFailure() {}

        function toast(title, icon = 'success') {
            Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500 }).fire({ icon, title });
        }
    </script>
</body>
</html>
