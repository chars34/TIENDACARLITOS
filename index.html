<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="icon" href="icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <title>Mini Super Carlitos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@300;400;600;700&family=Courier+Prime&display=swap');
        
        :root {
            --brand-red: #dc2626;
            --brand-white: #ffffff;
            --concrete-bg: #e5e7eb;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--concrete-bg); 
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .header-brand {
            font-family: 'Oswald', sans-serif;
            background-color: var(--brand-red);
            color: white;
            text-transform: uppercase;
            border-bottom: 4px solid #991b1b;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px;}
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-active { 
            background-color: white !important; 
            color: var(--brand-red) !important; 
            border-top: 4px solid var(--brand-red);
            margin-top: -4px;
            font-weight: 800;
        }

        .ticket-font { font-family: 'Courier Prime', monospace; }
        
        .bg-store-gradient {
            background: linear-gradient(rgba(220, 38, 38, 0.95), rgba(153, 27, 27, 0.95)), 
                        url('https://images.unsplash.com/photo-1534723452862-4c874018d66d?auto=format&fit=crop&q=80&w=1000');
            background-size: cover;
            background-position: center;
        }

        .btn-action {
            transition: all 0.15s ease-in-out;
        }
        .btn-action:active { transform: scale(0.96); }

        @media (max-width: 768px) {
            .pos-layout { flex-direction: column !important; }
            .cart-panel { width: 100% !important; height: 55vh !important; border-width: 2px 0 0 0; border-radius: 1rem 1rem 0 0; }
            .grid-products { grid-template-columns: repeat(2, 1fr) !important; }
            .header-info { display: none; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- LOGIN -->
    <div id="login-overlay" class="fixed inset-0 bg-store-gradient z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-sm w-full border-t-8 border-red-600">
            <div class="text-center mb-6 md:mb-8">
                <div class="inline-block p-4 bg-red-50 rounded-full mb-4">
                    <i class="fas fa-store text-4xl text-red-600"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-black text-gray-800 font-['Oswald'] uppercase tracking-tight">MINI SUPER CARLITOS</h2>
                <p class="text-gray-500 text-xs font-bold mt-1">SISTEMA DE ING.CHARS</p>
            </div>
            
            <div id="role-selection" class="space-y-3">
                <button onclick="selectRole('owner')" class="w-full flex items-center justify-between p-4 border-2 border-gray-100 rounded-xl hover:border-red-500 hover:bg-red-50 transition group btn-action">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-shield text-red-600 text-xl"></i>
                        <span class="font-bold text-gray-700">DUE√ëO</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-600"></i>
                </button>
                <button onclick="selectRole('employee')" class="w-full flex items-center justify-between p-4 border-2 border-gray-100 rounded-xl hover:border-gray-800 hover:bg-gray-50 transition group btn-action">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-cash-register text-gray-700 text-xl"></i>
                        <span class="font-bold text-gray-700">EMPLEADO</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-gray-800"></i>
                </button>
                
            </div>

            <div id="password-entry" class="hidden space-y-4">
                <button onclick="backToRoles()" class="text-xs text-red-600 font-bold mb-2 flex items-center gap-1 hover:text-red-800">
                    <i class="fas fa-arrow-left"></i> VOLVER
                </button>
                <input type="password" id="login-pass" placeholder="PIN" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-red-600 outline-none text-center text-2xl tracking-widest font-bold">
                <button onclick="attemptLogin()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-red-700 btn-action">ENTRAR</button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header-brand p-3 md:p-4 flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-3 md:gap-6">
            <div class="flex flex-col">
                <h1 class="text-xl md:text-2xl font-black leading-none tracking-tighter">MINI SUPER CARLITOS</h1>
                <span class="text-[8px] md:text-[10px] font-bold opacity-80">TECNOLOG√çA EN TU BARRIO</span>
            </div>
            <span id="role-indicator" class="text-[8px] md:text-[10px] px-2 py-1 rounded border border-white font-bold uppercase hidden md:inline-block"></span>
        </div>
        <div class="flex items-center gap-4 md:gap-6">
            <div id="clock" class="text-xs md:text-sm font-mono font-bold header-info tracking-widest bg-black/20 px-3 py-1 rounded-lg">00:00:00</div>
            <button onclick="logout()" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition border border-white/20 flex items-center gap-2">
                <i class="fas fa-power-off"></i> <span class="text-xs font-bold hidden md:inline-block">SALIR</span>
            </button>
        </div>
    </header>

    <nav id="nav-bar" class="bg-gray-200 border-b flex px-2 md:px-4 gap-1 pt-2 shadow-inner overflow-x-auto custom-scroll z-10 relative"></nav>

    <!-- MAIN VIEWS -->
    <main class="flex-1 overflow-hidden relative bg-gray-100">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="flex flex-col md:flex-row gap-3 mt-4 mb-6">
                <button onclick="sendReportWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 btn-action border-b-4 border-green-900 active:border-b-0 active:translate-y-1">
                    <i class="fab fa-whatsapp text-2xl"></i>
                    ENVIAR REPORTE STOCK BAJOS
                </button>
                 <button onclick="sendDailySummaryWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 btn-action border-b-4 border-green-900 active:border-b-0 active:translate-y-1">
                    <i class="fab fa-whatsapp text-2xl"></i>
                    ENVIAR REPORTE DE VENTA DEL DIA
                </button>
                <button onclick="sendSummaryWhatsApp()" 
class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 btn-action border-b-4 border-green-900 active:border-b-0 active:translate-y-1">

    <i class="fab fa-whatsapp text-2xl"></i>
     ENVIAR REPORTE DIA/SEM/MES

</button>
                
            </div>
            <div id="ownerPanel" class="hidden">

    <button onclick="sendStockWhatsApp()"
    class="bg-yellow-500 text-white px-4 py-2 rounded-xl w-full">
    Enviar stock bajo
    </button>

    <!-- AQUI EXACTO -->
    <button onclick="sendDailySummaryWhatsApp()"
    class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-bold w-full mt-2">
    <i class="fab fa-whatsapp mr-2"></i>
    Enviar resumen del d√≠a
    </button>

</div>
            <div class="max-w-6xl mx-auto">
                <h2 class="text-2xl font-black text-gray-800 font-['Oswald'] uppercase mb-6 border-l-4 border-red-600 pl-3">Resumen del D√≠a</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-emerald-500">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Ventas Efectivo</span>
                            <i class="fas fa-chart-line text-emerald-100 text-2xl"></i>
                        </div>
                        <div id="profit-day" class="text-4xl md:text-5xl font-black text-emerald-600 mt-2">$0.00</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-red-600">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Fiados Pendientes</span>
                            <i class="fas fa-book-open text-red-100 text-2xl"></i>
                        </div>
                        <div id="total-fiados" class="text-4xl md:text-5xl font-black text-red-600 mt-2">$0.00</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-gray-800">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Stock Cr√≠tico (< 5)</span>
                            <i class="fas fa-exclamation-triangle text-gray-200 text-2xl"></i>
                        </div>
                        <div id="low-stock-count" class="text-4xl md:text-5xl font-black text-gray-800 mt-2">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PUNTO DE VENTA -->
        <div id="view-pos" class="hidden h-full flex flex-col lg:flex-row p-2 md:p-4 gap-2 md:gap-4 pos-layout">
            <div class="flex-1 flex flex-col gap-2 md:gap-4 overflow-hidden">
                <div class="bg-white p-2 md:p-3 rounded-xl shadow-sm flex items-center gap-2 border-2 border-transparent focus-within:border-red-300 transition">
                    <button onclick="openScanner('pos')" class="bg-gray-800 text-white p-3 rounded-lg hover:bg-black transition btn-action flex items-center justify-center">
                        <i class="fas fa-camera text-lg"></i>
                    </button>
                    <div class="bg-red-600 text-white p-3 rounded-lg flex items-center justify-center">
                        <i class="fas fa-barcode text-lg"></i>
                    </div>
                    <input type="text" id="barcode-scanner" oninput="searchProductPOS(this.value)" placeholder="BUSCAR PRODUCTO..." class="flex-1 text-base md:text-xl font-black outline-none uppercase placeholder:text-gray-300 px-2 bg-transparent">
                    <button onclick="document.getElementById('barcode-scanner').value=''; searchProductPOS('');" class="text-gray-400 hover:text-red-600 p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="pos-grid" class="flex-1 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 md:gap-3 overflow-y-auto custom-scroll pr-1 content-start grid-products pb-20 md:pb-0">
                    <!-- Products rendered here ONLY when searched -->
                </div>
            </div>

            <div class="w-full lg:w-[350px] xl:w-[400px] bg-white rounded-xl shadow-xl flex flex-col overflow-hidden border border-gray-200 cart-panel z-20 flex-shrink-0">
                <div class="p-3 bg-gray-800 text-white flex justify-between items-center shadow-md z-10">
                    <h3 class="font-bold text-xs tracking-widest uppercase"><i class="fas fa-shopping-basket mr-2 text-red-400"></i> CARRITO</h3>
                    <button onclick="clearCart()" class="text-[10px] bg-red-600/80 px-3 py-1.5 rounded font-bold hover:bg-red-600 transition">VACIAR</button>
                </div>
                
                <div id="cart-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll bg-gray-50 ticket-font text-xs">
                    <!-- Cart items rendered here -->
                </div>
                
                <div class="p-4 md:p-5 bg-white border-t border-gray-200 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.05)] z-10">
                    <div class="flex justify-between items-end mb-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="text-gray-500 font-black uppercase text-[10px] tracking-widest">Total a Pagar</span>
                        <span id="cart-total" class="text-3xl md:text-4xl font-black text-red-600 leading-none">$0.00</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2" id="checkout-buttons-container">
                        <button onclick="openCheckout('cash')" class="bg-emerald-600 text-white p-3 rounded-xl font-bold hover:bg-emerald-700 shadow-sm flex flex-col items-center btn-action border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1 col-span-2 md:col-span-1" id="btn-checkout-cash">
                            <i class="fas fa-money-bill-wave text-2xl mb-1 opacity-80"></i> 
                            <span class="text-[10px] tracking-widest">EFECTIVO</span>
                        </button>
                        <button onclick="openCheckout('fiado')" class="bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 shadow-sm flex flex-col items-center btn-action border-b-4 border-red-800 active:border-b-0 active:translate-y-1 hidden md:flex" id="btn-checkout-fiado">
                            <i class="fas fa-book text-2xl mb-1 opacity-80"></i> 
                            <span class="text-[10px] tracking-widest">FIAR</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RECARGAS -->
        <div id="view-recargas" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-blue-600 mb-6">
                    <h2 class="text-2xl md:text-3xl font-black font-['Oswald'] text-gray-800 uppercase">Recargas Telef√≥nicas</h2>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">SELECCIONA COMPA√ë√çA Y MONTO</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-black text-gray-700 mb-4 uppercase text-sm border-b pb-2">1. Compa√±√≠a</h3>
                        <div class="grid grid-cols-3 gap-3" id="company-selector">
                            <button onclick="selectCompany('Telcel')" class="company-btn p-4 rounded-xl border-2 border-gray-200 hover:border-blue-500 focus:border-blue-500 flex flex-col items-center gap-2 transition">
                                <i class="fas fa-signal text-blue-600 text-2xl"></i>
                                <span class="text-xs font-bold text-gray-700">Telcel</span>
                            </button>
                            <button onclick="selectCompany('Movistar')" class="company-btn p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 focus:border-green-500 flex flex-col items-center gap-2 transition">
                                <i class="fas fa-signal text-green-500 text-2xl"></i>
                                <span class="text-xs font-bold text-gray-700">Movistar</span>
                            </button>
                            <button onclick="selectCompany('AT&T')" class="company-btn p-4 rounded-xl border-2 border-gray-200 hover:border-orange-500 focus:border-orange-500 flex flex-col items-center gap-2 transition">
                                <i class="fas fa-signal text-orange-500 text-2xl"></i>
                                <span class="text-xs font-bold text-gray-700">AT&T</span>
                            </button>
                        </div>

                        <h3 class="font-black text-gray-700 mb-4 mt-6 uppercase text-sm border-b pb-2">2. N√∫mero a 10 d√≠gitos</h3>
                        <input type="tel" id="recarga-phone" maxlength="10" placeholder="Ej: 5512345678" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-center text-xl tracking-[0.3em] outline-none focus:border-blue-500 transition">
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-black text-gray-700 mb-4 uppercase text-sm border-b pb-2">3. Monto</h3>
                        <div class="grid grid-cols-2 gap-3 mb-6" id="amount-selector">
                            <button onclick="selectAmount(20)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 focus:border-red-500 text-lg font-black text-gray-700 transition">$20</button>
                            <button onclick="selectAmount(50)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 focus:border-red-500 text-lg font-black text-gray-700 transition">$50</button>
                            <button onclick="selectAmount(100)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 focus:border-red-500 text-lg font-black text-gray-700 transition">$100</button>
                            <button onclick="selectAmount(200)" class="amount-btn p-4 rounded-xl border-2 border-gray-200 hover:border-red-500 focus:border-red-500 text-lg font-black text-gray-700 transition">$200</button>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center mb-4">
                            <span class="text-[10px] font-black text-gray-400 uppercase block">Resumen</span>
                            <div class="text-lg font-bold text-gray-800 mt-1" id="recarga-summary">Selecciona opciones</div>
                        </div>

                        <button onclick="processRecarga()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-blue-700 uppercase tracking-widest btn-action flex items-center justify-center gap-2" id="btn-process-recarga">
                            <i class="fas fa-bolt"></i> ENVIAR RECARGA
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FIADOS -->
        <div id="view-fiados" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 bg-white p-5 rounded-2xl shadow-sm border-l-8 border-red-600">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black font-['Oswald'] text-gray-800 uppercase">Clientes / Fiados</h2>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">GESTI√ìN DE CUENTAS POR COBRAR</p>
                    </div>
                    <!-- El bot√≥n de nuevo cliente solo se mostrar√° al due√±o -->
                    <button id="btn-new-customer" onclick="openModal('customer-add-modal')" class="hidden w-full md:w-auto bg-gray-800 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-black transition flex items-center justify-center gap-2 btn-action">
                        <i class="fas fa-user-plus"></i> NUEVO CLIENTE
                    </button>
                </div>
                
                <div class="mb-4 relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-customer" oninput="renderCustomers(this.value)" placeholder="BUSCAR CLIENTE..." class="w-full bg-white p-4 pl-12 rounded-xl shadow-sm outline-none font-bold uppercase border-2 border-transparent focus:border-red-300 transition">
                </div>

                <div id="customers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Customers rendered here -->
                </div>
            </div>
        </div>

        <!-- INVENTARIO -->
        <div id="view-inventory" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="bg-white rounded-2xl shadow-sm max-w-6xl mx-auto overflow-hidden flex flex-col h-full md:h-auto">
                <div class="p-4 md:p-6 bg-gray-800 text-white flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                    <div>
                        <h2 class="text-xl font-black uppercase font-['Oswald'] tracking-wide">Inventario</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">ADMINISTRACI√ìN DE PRODUCTOS</p>
                    </div>
                    <div class="flex w-full sm:w-auto gap-2">
                        <button onclick="openProductModal()" class="flex-1 sm:flex-none bg-red-600 text-white px-4 py-2.5 rounded-lg text-xs font-bold hover:bg-red-700 flex items-center justify-center gap-2 transition">
                            <i class="fas fa-plus"></i> PRODUCTO
                        </button>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="relative max-w-md">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-inventory" oninput="renderInventory(this.value)" placeholder="BUSCAR EN INVENTARIO..." class="w-full bg-white p-3 pl-10 rounded-lg outline-none font-bold uppercase border border-gray-300 focus:border-red-500 text-sm">
                    </div>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full min-w-[700px] text-left">
                        <thead class="bg-gray-100 text-gray-500 text-[10px] font-black uppercase tracking-widest border-b">
                            <tr>
                                <th class="p-4 w-16 text-center">C√≥digo</th>
                                <th class="p-4">Producto</th>
                                <th class="p-4 text-right">Costo</th>
                                <th class="p-4 text-right">Precio Venta</th>
                                <th class="p-4 text-center">Stock</th>
                                <th class="p-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body" class="divide-y divide-gray-100 bg-white text-sm font-medium text-gray-700">
                            <!-- Inventory items here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    
    <!-- Modal Scanner -->
    <div id="scanner-modal" class="hidden fixed inset-0 bg-black/95 z-[2000] flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="w-full max-w-md bg-white rounded-2xl overflow-hidden shadow-2xl relative">
            <div class="p-4 bg-red-600 text-white text-center font-black uppercase tracking-widest flex justify-between items-center">
                <span>Escanear C√≥digo</span>
                <button onclick="closeScanner()" class="text-white hover:text-red-200 p-1"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="reader" class="w-full bg-black min-h-[300px]"></div>
            <div class="p-4 bg-gray-50 text-center">
                <p class="text-xs text-gray-500 font-bold mb-3 uppercase">Apunta la c√°mara al c√≥digo de barras</p>
                <button onclick="closeScanner()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold uppercase text-xs btn-action">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Checkout -->
    <div id="checkout-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 border-t-8 border-red-600 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-start mb-4">
                <h3 id="checkout-title" class="text-lg font-black uppercase tracking-widest text-gray-800">COBRAR</h3>
                <button onclick="closeModal('checkout-modal')" class="text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100 text-center">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">TOTAL A COBRAR</span>
                <div id="checkout-total-display" class="text-5xl font-black text-red-600 font-['Oswald']"></div>
            </div>
            
            <div id="cash-payment-fields" class="space-y-4 hidden">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Efectivo Recibido</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-black text-2xl">$</span>
                        <input type="number" id="cash-received" oninput="calcChange()" placeholder="0.00" class="w-full p-4 pl-10 bg-white border-2 border-gray-200 rounded-xl text-3xl text-right font-black focus:border-emerald-500 outline-none transition">
                    </div>
                </div>
                <div class="bg-emerald-50 p-4 rounded-xl border-2 border-emerald-100 flex justify-between items-center">
                    <span class="text-[10px] text-emerald-800 font-black uppercase">Cambio</span>
                    <div id="cash-change" class="text-2xl font-black text-emerald-600">$0.00</div>
                </div>
            </div>

            <div id="fiado-fields" class="space-y-4 hidden">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Seleccionar Cliente</label>
                    <select id="customer-select" class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl font-bold text-gray-700 outline-none focus:border-red-500 transition">
                        <!-- Clientes options -->
                    </select>
                </div>
                <div class="text-[10px] text-center text-gray-500 bg-gray-50 p-3 rounded-lg border border-dashed border-gray-300">
                    Esta venta se registrar√° como deuda en la cuenta del cliente seleccionado.
                </div>
            </div>

            <div class="pt-6 space-y-3">
                <button onclick="finalizeSale()" class="w-full bg-red-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-red-700 uppercase tracking-widest btn-action flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> CONFIRMAR VENTA
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Producto -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md border-t-8 border-gray-800 shadow-2xl relative max-h-[90vh] overflow-y-auto custom-scroll">
            <button onclick="closeModal('product-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            
            <h3 id="product-modal-title" class="font-black mb-6 text-xl uppercase tracking-widest text-gray-800">NUEVO PRODUCTO</h3>
            
            <form id="product-form" class="space-y-4" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="p-id">
                
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">C√≥digo de Barras</label>
                    <div class="flex gap-2">
                        <input type="text" id="p-code" placeholder="ESCRIBE O ESCANEA..." class="flex-1 p-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-mono font-bold outline-none focus:border-red-500 uppercase">
                        <button type="button" onclick="openScanner('stock')" class="bg-gray-800 hover:bg-black text-white px-4 py-3 rounded-xl font-bold transition btn-action flex items-center justify-center gap-2 shadow-md border-b-4 border-gray-900 active:border-b-0 active:translate-y-[2px]">
                            <i class="fas fa-camera text-lg"></i>
                            <span class="hidden sm:inline">ESCANEAR</span>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Nombre del Producto</label>
                    <input type="text" id="p-name" required placeholder="EJ: COCA COLA 600ML" class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold uppercase outline-none focus:border-red-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Costo Compra</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                            <input type="number" id="p-cost" step="0.01" min="0" required placeholder="0.00" class="w-full p-3 pl-8 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold outline-none focus:border-red-500 text-right">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-red-500 uppercase ml-1">Precio Venta</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-400 font-bold">$</span>
                            <input type="number" id="p-price" step="0.01" min="0" required placeholder="0.00" class="w-full p-3 pl-8 bg-red-50 border-2 border-red-200 rounded-xl font-black text-red-600 outline-none focus:border-red-500 text-right">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Stock Actual</label>
                    <input type="number" id="p-stock" required min="0" placeholder="0" class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-black text-center text-xl outline-none focus:border-red-500">
                </div>

                <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-red-700 uppercase tracking-widest btn-action mt-4">
                    GUARDAR PRODUCTO
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div id="customer-add-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm border-t-8 border-gray-800 shadow-2xl relative">
            <button onclick="closeModal('customer-add-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="font-black mb-6 text-xl uppercase tracking-widest text-gray-800">NUEVO CLIENTE</h3>
            <form onsubmit="handleCustomerSubmit(event)" class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Nombre del Cliente</label>
                    <input type="text" id="c-name" required placeholder="Juan P√©rez" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold uppercase outline-none focus:border-red-500 transition">
                </div>
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Tel√©fono (Opcional)</label>
                    <input type="tel" id="c-phone" placeholder="10 D√≠gitos" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold outline-none focus:border-red-500 transition">
                </div>
                <button type="submit" class="w-full bg-gray-800 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-black uppercase tracking-widest btn-action mt-2">
                    <i class="fas fa-save mr-2"></i> GUARDAR CLIENTE
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Abonar a Fiado -->
    <div id="abono-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm border-t-8 border-emerald-500 shadow-2xl relative">
            <button onclick="closeModal('abono-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-red-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="font-black mb-2 text-xl uppercase tracking-widest text-gray-800">RECIBIR ABONO</h3>
            <p id="abono-customer-name" class="text-sm font-bold text-gray-500 uppercase mb-4"></p>
            
            <div class="bg-red-50 p-4 rounded-xl mb-4 border border-red-100 text-center">
                <span class="text-[10px] font-black text-red-400 uppercase tracking-widest block mb-1">DEUDA ACTUAL</span>
                <div id="abono-current-debt" class="text-3xl font-black text-red-600 font-['Oswald']"></div>
            </div>

            <form onsubmit="handleAbonoSubmit(event)" class="space-y-4">
                <input type="hidden" id="abono-customer-id">
                <div>
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-1 block mb-1">Monto a Abonar</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-black text-2xl">$</span>
                        <input type="number" id="abono-amount" step="0.01" min="0.01" required placeholder="0.00" class="w-full p-4 pl-10 bg-white border-2 border-gray-200 rounded-xl text-3xl text-right font-black focus:border-emerald-500 outline-none transition">
                    </div>
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-emerald-700 uppercase tracking-widest btn-action mt-2">
                    <i class="fas fa-hand-holding-usd mr-2"></i> REGISTRAR PAGO
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS Y ESTADO ---
        let currentRole = localStorage.getItem("role") || "due√±o";
        let db = {
            products: [
                { id: 1, code: "75010011", name: "COCA COLA 600ML", cost: 12.00, price: 18.00, stock: 24 },
                { id: 2, code: "75010022", name: "SABRITAS SAL 40G", cost: 10.00, price: 16.00, stock: 3 }, // Stock bajo de ejemplo
                { id: 3, code: "75010033", name: "LECHE LALA 1L", cost: 20.00, price: 26.00, stock: 12 }
            ],
            customers: [
                { id: 1, name: "Do√±a Mary", phone: "5512345678", debt: 150.50 },
                { id: 2, name: "Don Pepe", phone: "5587654321", debt: 45.00 }
            ],
            dailySales: 0
        };
        function showSalesSummary(){

    const s = getSalesSummary();

    Swal.fire({
        title: "Resumen de Ventas",
        html: `
        <div style="text-align:left;font-size:16px">
        Hoy: <b>$${s.day.toFixed(2)}</b><br><br>
        Semana: <b>$${s.week.toFixed(2)}</b><br><br>
        Mes: <b>$${s.month.toFixed(2)}</b>
        </div>
        `,
        icon: "info"
    });

}
        function sendDailySummaryWhatsApp(){

    if(currentRole !== "owner"){
        Swal.fire("Acceso denegado", "Solo el due√±o puede enviar resumen", "error");
        return;
    }

    let sales = JSON.parse(localStorage.getItem("sales")) || [];

    let today = new Date().toISOString().split("T")[0];

    let todaySales = sales.filter(s => s.date.startsWith(today));

    if(todaySales.length === 0){
        Swal.fire("Sin ventas", "No hay ventas hoy", "info");
        return;
    }

    let totalVentas = 0;
    let totalGanancias = 0;
    let productos = {};

    todaySales.forEach(sale => {

        totalVentas += sale.total;

        sale.items.forEach(item => {

            totalGanancias += (item.price - (item.cost || 0)) * item.qty;

            if(!productos[item.name]){
                productos[item.name] = 0;
            }

            productos[item.name] += item.qty;

        });

    });

    // producto m√°s vendido
    let masVendido = Object.keys(productos).reduce((a,b)=>
        productos[a] > productos[b] ? a : b
    );

    let mensaje =
`üìä RESUMEN DEL D√çA - CARLITOS

üí∞ Ventas totales: $${totalVentas.toFixed(2)}

üìà Ganancias: $${totalGanancias.toFixed(2)}

üèÜ Producto m√°s vendido:
${masVendido} (${productos[masVendido]} vendidos)

üìÖ Fecha: ${today}
`;

    let numero = "2371062600"; // ‚Üê TU NUMERO

    let url = `https://wa.me/2371062600?text=${encodeURIComponent(mensaje)}`;

    window.open(url, "_blank");

}
function renderCustomers(search = "") {

    let html = "";

    db.customers
    .filter(c => c.name.toLowerCase().includes(search.toLowerCase()))
    .forEach((customer, index) => {

  html += `
<div class="bg-white rounded-2xl p-5 shadow border relative">

    <!-- BOTON ELIMINAR -->
    <button onclick="deleteCustomer(${customer.id})"
    class="absolute top-3 right-3 bg-red-500 hover:bg-red-700 text-white w-8 h-8 rounded-full">
        üóë
    </button>

    <h3 class="font-bold text-gray-800 text-lg">
        ${customer.name}
    </h3>

    <p class="text-gray-500 text-sm">
        üìû ${customer.phone || ""}
    </p>

    <p class="mt-2 text-sm text-gray-500">
        DEUDA TOTAL
    </p>

    <p class="text-2xl font-black ${customer.debt > 0 ? 'text-red-600':'text-green-600'}">
        $${customer.debt.toFixed(2)}
    </p>

    <button onclick="openAbonoModal(${customer.id})"
    class="mt-3 w-full border border-green-500 text-green-600 py-2 rounded-xl hover:bg-green-50">
        ABONAR PAGO
    </button>

</div>
`;
    });

    document.getElementById("customers-grid").innerHTML = html;

}
function deleteCustomer(id){

    Swal.fire({
        title: "Eliminar cliente",
        text: "Se eliminar√° el cliente",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc2626",
        confirmButtonText: "Eliminar"
    }).then((result) => {

        if(result.isConfirmed){

            db.customers = db.customers.filter(c => c.id !== id);

            saveData();

            renderCustomers();

        }
 if(currentRole !== "due√±o"){
        Swal.fire("Acceso denegado", "Solo el due√±o puede eliminar fiados", "error");
        return;
    }
    });

}
        // Cargar datos locales si existen
        function loadData() {
            const saved = localStorage.getItem('miniSuperDB');
            if(saved) db = JSON.parse(saved);
        }
        if(!db.salesHistory){
        db.salesHistory = [];
    }
        function saveData() {
            localStorage.setItem('miniSuperDB', JSON.stringify(db));
            updateDashboard();
        }

        // --- AUTH Y NAVEGACI√ìN ---
        let selectedRoleAttempt = null;
        
        function selectRole(role) {
            selectedRoleAttempt = role;
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('password-entry').classList.remove('hidden');
            document.getElementById('login-pass').value = '';
            document.getElementById('login-pass').focus();
        }

        function backToRoles() {
            selectedRoleAttempt = null;
            document.getElementById('password-entry').classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
        }

        function attemptLogin() {
            const pin = document.getElementById('login-pass').value;
            if (selectedRoleAttempt === 'owner' && pin === 'admin123') {
                login('owner');
            } else if (selectedRoleAttempt === 'employee' && pin === 'user123') {
                login('employee');
            } else {
                Swal.fire('Error', 'PIN Incorrecto', 'error');
            }
        }

        function login(role) {
            currentRole = role;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('role-indicator').innerText = role === 'owner' ? 'Due√±o' : 'Empleado';
            document.getElementById('role-indicator').classList.remove('hidden');
            
            buildNav();
            loadData();
            
            // L√≥gica espec√≠fica por rol
            if(role === 'employee') {
                // Empleado NO puede agregar clientes ni FIAR en el POS
                document.getElementById('btn-new-customer').classList.add('hidden');
                document.getElementById('btn-checkout-fiado').classList.add('hidden');
                document.getElementById('btn-checkout-cash').classList.remove('md:col-span-1');
                document.getElementById('btn-checkout-cash').classList.add('col-span-2');
                switchView('view-pos'); // Empleado empieza en el POS
            } else {
                // Due√±o ve todo
                document.getElementById('btn-new-customer').classList.remove('hidden');
                document.getElementById('btn-checkout-fiado').classList.remove('hidden');
                document.getElementById('btn-checkout-cash').classList.add('md:col-span-1');
                document.getElementById('btn-checkout-cash').classList.remove('col-span-2');
                switchView('view-dashboard'); // Due√±o empieza en dashboard
            }
        }

        function logout() {
            currentRole = null;
            document.getElementById('login-overlay').classList.remove('hidden');
            backToRoles();
        }

        const navItems = [
            { id: 'view-dashboard', icon: 'fa-chart-pie', text: 'Resumen', role: 'owner' },
            { id: 'view-pos', icon: 'fa-cash-register', text: 'Caja', role: 'all' },
            { id: 'view-recargas', icon: 'fa-mobile-alt', text: 'Recargas', role: 'all' },
            { id: 'view-fiados', icon: 'fa-book', text: 'Fiados', role: 'all' },
            { id: 'view-inventory', icon: 'fa-boxes', text: 'Inventario', role: 'owner' }
        ];

        function buildNav() {
            const nav = document.getElementById('nav-bar');
            nav.innerHTML = '';
            navItems.forEach(item => {
                if (item.role === 'all' || item.role === currentRole) {
                    const btn = document.createElement('button');
                    btn.className = `flex-1 min-w-[80px] py-3 md:py-4 px-2 text-[10px] md:text-xs font-bold uppercase tracking-widest text-gray-500 rounded-t-xl transition-all hover:bg-gray-100 flex flex-col items-center gap-1 md:gap-2 btn-nav`;
                    btn.onclick = () => switchView(item.id);
                    btn.dataset.target = item.id;
                    btn.innerHTML = `<i class="fas ${item.icon} text-lg md:text-xl"></i><span>${item.text}</span>`;
                    nav.appendChild(btn);
                }
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            document.querySelectorAll('.btn-nav').forEach(el => el.classList.remove('tab-active'));
            const activeBtn = document.querySelector(`.btn-nav[data-target="${viewId}"]`);
            if(activeBtn) activeBtn.classList.add('tab-active');

            if(viewId === 'view-dashboard') updateDashboard();
            if(viewId === 'view-fiados') renderCustomers('');
            if(viewId === 'view-inventory') renderInventory('');
        }
function sendSummaryWhatsApp(){

    if(!db.salesHistory) db.salesHistory = [];

    const s = getSalesSummary();

    const text =
`Resumen Mini Super Carlitos

Hoy: $${s.day.toFixed(2)}
Semana: $${s.week.toFixed(2)}
Mes: $${s.month.toFixed(2)}`;

    const url = "https://wa.me/2371062600?text=" + encodeURIComponent(text);

    window.open(url, "_blank");
}
        // --- DASHBOARD ---
        function updateDashboard() {
            if(currentRole !== 'owner') return;
            document.getElementById('profit-day').innerText = `$${db.dailySales.toFixed(2)}`;
            const totalFiados = db.customers.reduce((sum, c) => sum + c.debt, 0);
            document.getElementById('total-fiados').innerText = `$${totalFiados.toFixed(2)}`;
            const lowStockCount = db.products.filter(p => p.stock < 5).length;
            document.getElementById('low-stock-count').innerText = lowStockCount;
        }

        function sendReportWhatsApp() {
            const lowStockItems = db.products.filter(p => p.stock < 5);
            if(lowStockItems.length === 0) {
                return Swal.fire('Todo Excelente', 'No tienes productos con stock bajo.', 'success');
            }

            let msg = "‚ö†Ô∏è *REPORTE DE STOCK BAJO* ‚ö†Ô∏è\n_Mini Super Carlitos_\n\n";
            msg += "Los siguientes productos tienen menos de 5 unidades:\n\n";
            
            lowStockItems.forEach(p => {
                msg += `üî∏ *${p.name}*: Quedan ${p.stock}\n`;
            });
            msg += "\nPor favor, realizar pedido.";
            
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- PUNTO DE VENTA (POS) ---
        let cart = [];

        function searchProductPOS(query) {
            const grid = document.getElementById('pos-grid');
            if(!query.trim()) {
                grid.innerHTML = '';
                return;
            }
            const q = query.toLowerCase();
            const results = db.products.filter(p => p.name.toLowerCase().includes(q) || p.code.includes(q));
            
            grid.innerHTML = results.map(p => `
                <button onclick="addToCart(${p.id})" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:border-red-500 hover:shadow-md transition text-left flex flex-col justify-between aspect-square btn-action relative overflow-hidden">
                    ${p.stock < 5 ? '<div class="absolute top-0 right-0 bg-red-600 text-white text-[8px] font-bold px-2 py-1 rounded-bl-lg">¬°POCO STOCK!</div>' : ''}
                    <div>
                        <div class="text-[9px] font-black text-gray-400 uppercase tracking-widest break-words">${p.code}</div>
                        <div class="font-bold text-gray-800 text-xs mt-1 leading-tight uppercase line-clamp-3">${p.name}</div>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <span class="text-xs text-gray-500 font-bold">Disp: ${p.stock}</span>
                        <span class="font-black text-red-600 text-lg">$${p.price.toFixed(2)}</span>
                    </div>
                </button>
            `).join('');
        }

        function addToCart(id) {
            const product = db.products.find(p => p.id === id);
            if(!product) return;
            if(product.stock <= 0) {
                Swal.fire('Sin Stock', 'No hay unidades disponibles', 'error');
                return;
            }

            const exist = cart.find(c => c.id === id);
            if(exist) {
                if(exist.qty >= product.stock) {
                    Swal.fire('L√≠mite', 'No hay m√°s stock disponible', 'warning');
                    return;
                }
                exist.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            renderCart();
            // Limpiar b√∫squeda
            document.getElementById('barcode-scanner').value = '';
            document.getElementById('pos-grid').innerHTML = '';
        }

        function removeFromCart(id) {
            cart = cart.filter(c => c.id !== id);
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            let total = 0;
            list.innerHTML = cart.map(item => {
                const sub = item.qty * item.price;
                total += sub;
                return `
                <div class="bg-white p-2 rounded border border-gray-100 flex justify-between items-center shadow-sm">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800 truncate pr-2 uppercase">${item.name}</div>
                        <div class="text-gray-500 mt-0.5">${item.qty} x $${item.price.toFixed(2)}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-gray-800">$${sub.toFixed(2)}</span>
                        <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');
            
            if(cart.length === 0) list.innerHTML = '<div class="text-center text-gray-400 mt-10 text-[10px] uppercase font-bold tracking-widest">Carrito Vac√≠o</div>';
            document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
        }

        function clearCart() { cart = []; renderCart(); }

        // --- CHECKOUT ---
        let checkoutType = 'cash'; // 'cash' o 'fiado'

        function openCheckout(type) {
            if(cart.length === 0) return Swal.fire('Error', 'El carrito est√° vac√≠o', 'error');
            
            checkoutType = type;
            const total = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
            document.getElementById('checkout-total-display').innerText = `$${total.toFixed(2)}`;
            
            if(type === 'cash') {
                document.getElementById('checkout-title').innerText = 'COBRAR EN EFECTIVO';
                document.getElementById('cash-payment-fields').classList.remove('hidden');
                document.getElementById('fiado-fields').classList.add('hidden');
                document.getElementById('cash-received').value = '';
                document.getElementById('cash-change').innerText = '$0.00';
            } else {
                document.getElementById('checkout-title').innerText = 'REGISTRAR FIADO';
                document.getElementById('cash-payment-fields').classList.add('hidden');
                document.getElementById('fiado-fields').classList.remove('hidden');
                
                // Cargar clientes
                const select = document.getElementById('customer-select');
                select.innerHTML = '<option value="">-- Seleccionar Cliente --</option>' + 
                    db.customers.map(c => `<option value="${c.id}">${c.name} (Deuda: $${c.debt.toFixed(2)})</option>`).join('');
            }
            
            openModal('checkout-modal');
            if(type === 'cash') setTimeout(() => document.getElementById('cash-received').focus(), 100);
        }

        function calcChange() {
            const total = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const rec = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = rec - total;
            const display = document.getElementById('cash-change');
            if(change >= 0) {
                display.innerText = `$${change.toFixed(2)}`;
                display.classList.remove('text-red-600');
                display.classList.add('text-emerald-600');
            } else {
                display.innerText = `Falta $${Math.abs(change).toFixed(2)}`;
                display.classList.remove('text-emerald-600');
                display.classList.add('text-red-600');
            }
        }

        function finalizeSale() {
            const total = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
            
            if(checkoutType === 'cash') {
                const rec = parseFloat(document.getElementById('cash-received').value) || 0;
                if(rec < total) return Swal.fire('Error', 'El efectivo recibido es insuficiente.', 'error');
                
                // Procesar pago efectivo: Sumar a ventas del d√≠a
            // Procesar pago efectivo
db.dailySales += total;

db.salesHistory.push({
    amount: total,
    date: new Date().toISOString(),
    type: "venta"
});



saveData();
                Swal.fire('Venta Exitosa', `Cambio: $${(rec - total).toFixed(2)}`, 'success');
                
            } else if(checkoutType === 'fiado') {
                const cid = parseInt(document.getElementById('customer-select').value);
                if(!cid) return Swal.fire('Error', 'Selecciona un cliente para fiar.', 'error');
                
                // Procesar fiado: Sumar a la deuda del cliente
                const customer = db.customers.find(c => c.id === cid);
                customer.debt += total;
                Swal.fire('Fiado Registrado', `Agregado a la cuenta de ${customer.name}.`, 'success');
            }


            // Descontar inventario
            cart.forEach(item => {
                const p = db.products.find(x => x.id === item.id);
                if(p) p.stock -= item.qty;
            });
// GUARDAR VENTA PARA REPORTES
let sales = JSON.parse(localStorage.getItem("sales")) || [];

sales.push({

    items: cart,
    total: total,
    date: new Date().toISOString()

});

localStorage.setItem("sales", JSON.stringify(sales));
            saveData();
            clearCart();
            closeModal('checkout-modal');
        }


        // --- FIADOS Y CLIENTES ---
        function renderCustomers(query) {
            const grid = document.getElementById('customers-grid');
            const q = query.toLowerCase();
            const results = db.customers.filter(c => c.name.toLowerCase().includes(q));
            
            grid.innerHTML = results.map(c => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-black text-gray-800 uppercase">${c.name}</h4>
                            <div class="bg-gray-100 p-2 rounded-full text-gray-400"><i class="fas fa-user"></i></div>
                        </div>
                        <p class="text-[10px] text-gray-500 font-bold mb-4"><i class="fas fa-phone mr-1"></i> ${c.phone || 'Sin n√∫mero'}</p>
                    </div>
                    <div>
                        <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Deuda Total</div>
                        <div class="text-3xl font-black ${c.debt > 0 ? 'text-red-600' : 'text-emerald-600'} font-['Oswald'] mb-4">$${c.debt.toFixed(2)}</div>
                        <button onclick="openAbonoModal(${c.id})" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold uppercase text-xs tracking-widest border border-emerald-200 hover:bg-emerald-600 hover:text-white transition btn-action">
                            ABONAR PAGO
                        </button>
                      ${currentRole === "owner" ? `
<button onclick="deleteCustomer(${c.id})"
class="bg-red-500 hover:bg-red-700 text-white w-8 h-8 rounded-full flex items-center justify-center mt-2">
    <i class="fas fa-trash text-xs"></i>
</button>
` : ``}
                    </div>
                </div>
            `).join('');
        }
function deleteCustomer(id){

    if(currentRole !== "owner"){
        Swal.fire("Acceso denegado", "Solo el due√±o puede eliminar fiados", "error");
        return;
    }

    Swal.fire({
        title: "Eliminar cliente",
        text: "Se eliminar√° el cliente",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc2626",
        confirmButtonText: "Eliminar"
    }).then((result) => {

        if(result.isConfirmed){

            db.customers = db.customers.filter(c => c.id !== id);

            saveData();

            renderCustomers("");

            Swal.fire("Eliminado", "Cliente eliminado correctamente", "success");

        }

    });

}
        function handleCustomerSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('c-name').value;
            const phone = document.getElementById('c-phone').value;
            
            db.customers.push({ id: Date.now(), name, phone, debt: 0 });
            saveData();
            closeModal('customer-add-modal');
            renderCustomers('');
            Swal.fire('Guardado', 'Cliente registrado correctamente.', 'success');
            e.target.reset();
        }

        function openAbonoModal(cid) {
            const customer = db.customers.find(c => c.id === cid);
            if(customer.debt <= 0) return Swal.fire('Sin Deuda', 'Este cliente no tiene deudas pendientes.', 'info');
            
            document.getElementById('abono-customer-id').value = customer.id;
            document.getElementById('abono-customer-name').innerText = customer.name;
            document.getElementById('abono-current-debt').innerText = `$${customer.debt.toFixed(2)}`;
            document.getElementById('abono-amount').value = '';
            
            openModal('abono-modal');
            setTimeout(() => document.getElementById('abono-amount').focus(), 100);
        }

        function handleAbonoSubmit(e) {
            e.preventDefault();
            const cid = parseInt(document.getElementById('abono-customer-id').value);
            const amount = parseFloat(document.getElementById('abono-amount').value);
            
            const customer = db.customers.find(c => c.id === cid);
            if(amount > customer.debt) {
                return Swal.fire('Aviso', 'El abono no puede ser mayor a la deuda.', 'warning');
            }

            customer.debt -= amount;
            // El abono entra como efectivo a la caja, por lo que suma a las ventas del d√≠a
            db.dailySales += amount; 
            
            saveData();
            closeModal('abono-modal');
            renderCustomers('');
            Swal.fire('√âxito', `Abono de $${amount.toFixed(2)} registrado correctamente.`, 'success');
        }

        // --- INVENTARIO ---
        function renderInventory(query) {
            const tbody = document.getElementById('inventory-body');
            const q = query.toLowerCase();
            const results = db.products.filter(p => p.name.toLowerCase().includes(q) || p.code.includes(q));
            
            tbody.innerHTML = results.map(p => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4 font-mono text-xs text-gray-500">${p.code}</td>
                    <td class="p-4 font-bold uppercase">${p.name}</td>
                    <td class="p-4 text-right text-gray-500">$${p.cost.toFixed(2)}</td>
                    <td class="p-4 text-right font-black text-red-600">$${p.price.toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <span class="${p.stock < 5 ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'} px-3 py-1 rounded-full text-xs font-bold">
                            ${p.stock}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="editProduct(${p.id})" class="text-blue-500 hover:text-blue-700 mx-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700 mx-2"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openProductModal() {
            document.getElementById('product-form').reset();
            document.getElementById('p-id').value = '';
            document.getElementById('product-modal-title').innerText = 'NUEVO PRODUCTO';
            openModal('product-modal');
        }

        function editProduct(id) {
            const p = db.products.find(x => x.id === id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-code').value = p.code;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-cost').value = p.cost;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-stock').value = p.stock;
            document.getElementById('product-modal-title').innerText = 'EDITAR PRODUCTO';
            openModal('product-modal');
        }

      function handleProductSubmit(e) {

    e.preventDefault();

    const id = document.getElementById('p-id').value;

    const productId = id ? parseInt(id) : null;

    const code = document.getElementById('p-code').value.trim();

    const name = document.getElementById('p-name').value;

    const cost = parseFloat(document.getElementById('p-cost').value);

    const price = parseFloat(document.getElementById('p-price').value);

    const stock = parseInt(document.getElementById('p-stock').value);


    // VALIDAR CODIGO DUPLICADO
    const existe = db.products.find(p => 
        p.code === code && p.id !== productId
    );

    if (existe) {

        Swal.fire({
            icon: "error",
            title: "C√≥digo duplicado",
            text: "Este c√≥digo de barras ya est√° registrado",
            confirmButtonColor: "#dc2626"
        });

        return;
    }


    const product = {

        code,
        name,
        cost,
        price,
        stock

    };


    if (productId) {

        const idx = db.products.findIndex(p => p.id === productId);

        db.products[idx] = {

            ...product,
            id: productId

        };

    } else {

        db.products.push({

            ...product,
            id: Date.now()

        });

    }


    saveData();

    closeModal('product-modal');

    renderInventory(document.getElementById('search-inventory').value);

    Swal.fire({

        icon: "success",
        title: "Producto guardado",
        timer: 1200,
        showConfirmButton: false

    });

}

Swal.fire({
    icon: "success",
    title: "Producto guardado",
    text: "Registro exitoso",
    timer: 1500,
    showConfirmButton: false
});

        // --- RECARGAS ---
        let recargaData = { company: null, amount: null };
        function selectCompany(comp) {
            recargaData.company = comp;
            document.querySelectorAll('.company-btn').forEach(b => b.classList.remove('border-blue-500', 'border-green-500', 'border-orange-500', 'bg-gray-50'));
            const colors = { 'Telcel': 'border-blue-500', 'Movistar': 'border-green-500', 'AT&T': 'border-orange-500' };
            event.currentTarget.classList.add(colors[comp], 'bg-gray-50');
            updateRecargaSummary();
        }
        function selectAmount(amt) {
            recargaData.amount = amt;
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('border-red-500', 'bg-red-50', 'text-red-600'));
            event.currentTarget.classList.add('border-red-500', 'bg-red-50', 'text-red-600');
            updateRecargaSummary();
        }
        function updateRecargaSummary() {
            const phone = document.getElementById('recarga-phone').value;
            let text = '';
            if(recargaData.company) text += `<span class="text-blue-600">${recargaData.company}</span> `;
            if(recargaData.amount) text += `| <span class="text-red-600">$${recargaData.amount}</span> `;
            document.getElementById('recarga-summary').innerHTML = text || 'Selecciona opciones';
        }

        document.getElementById('recarga-phone').addEventListener('input', updateRecargaSummary);

        function processRecarga() {
            const phone = document.getElementById('recarga-phone').value;
            if(!recargaData.company || !recargaData.amount || phone.length !== 10) {
                return Swal.fire('Error', 'Completa los 3 pasos (Compa√±√≠a, N√∫mero 10 d√≠gitos, Monto)', 'error');
            }

            Swal.fire({
                title: 'Confirmar Recarga',
                html: `¬øEnviar <b>$${recargaData.amount}</b> a <b>${recargaData.company}</b><br>al n√∫mero <b>${phone}</b>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                confirmButtonText: 'Confirmar y Cobrar'
            }).then((result) => {
                if(result.isConfirmed) {
                    db.dailySales += recargaData.amount;

db.salesHistory.push({
    amount: recargaData.amount,
    date: new Date().toISOString(),
    type: "recarga"
});

saveData();
                    Swal.fire('Recarga Exitosa', 'Folio: ' + Math.floor(Math.random()*1000000), 'success');
                    
                    // Reset formulario recargas
                    recargaData = { company: null, amount: null };
                    document.getElementById('recarga-phone').value = '';
                    document.querySelectorAll('.company-btn, .amount-btn').forEach(b => b.classList.remove('border-blue-500', 'border-green-500', 'border-orange-500', 'border-red-500', 'bg-gray-50', 'bg-red-50', 'text-red-600'));
                    updateRecargaSummary();
                }
            });
        }
function getSalesSummary(){

    if(!db.salesHistory) return { day:0, week:0, month:0 };

    const today = new Date();

    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    const startOfWeek = new Date(today);
    startOfWeek.setHours(0,0,0,0);
    startOfWeek.setDate(today.getDate() - today.getDay());

    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

    let day = 0;
    let week = 0;
    let month = 0;

    db.salesHistory.forEach(sale => {

        const saleDate = new Date(sale.date);

        if(saleDate >= startOfDay)
            day += sale.amount;

        if(saleDate >= startOfWeek)
            week += sale.amount;

        if(saleDate >= startOfMonth)
            month += sale.amount;

    });

    return { day, week, month };

}
        // --- UTILIDADES ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Reloj
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('es-MX', { hour12: false });
        }, 1000);

        // --- SCANNER STUB ---
        // Se deja como stub para no abrir c√°mara autom√°ticamente, requiere https:// para funcionar en producci√≥n

let html5QrCode;

function openScanner(context){

    openModal('scanner-modal');

    const reader = document.getElementById("reader");

    reader.innerHTML = "";

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        {
            facingMode: "environment" // FUERZA c√°mara trasera
        },
        {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        },
        (decodedText) => {

            if(context === "stock"){
                document.getElementById("p-code").value = decodedText;
            }

            if(context === "pos"){
                document.getElementById("barcode-scanner").value = decodedText;
                searchProductPOS(decodedText);
            }

            closeScanner();

        },
        (errorMessage) => {
            // ignorar errores normales
        }

    ).catch(err => {

        alert("Error al abrir c√°mara: " + err);

    });

}
function closeScanner(){

    if(html5QrCode){
        html5QrCode.stop().then(()=>{
            html5QrCode.clear();
        }).catch(()=>{});
    }

    closeModal('scanner-modal');

}
renderCustomers();
    </script>
</body>
</html>
