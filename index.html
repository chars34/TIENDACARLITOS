<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema POS - Mini Super Carlitos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@300;400;600;700&family=Courier+Prime&display=swap');
        
        :root {
            --brand-red: #dc2626;
            --brand-white: #ffffff;
            --concrete-bg: #e5e7eb;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--concrete-bg); 
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .header-brand {
            font-family: 'Oswald', sans-serif;
            background-color: var(--brand-red);
            color: white;
            text-transform: uppercase;
            border-bottom: 4px solid #991b1b;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        
        .tab-active { 
            background-color: white !important; 
            color: var(--brand-red) !important; 
            border-top: 4px solid var(--brand-red);
            margin-top: -4px;
            font-weight: 800;
        }

        .ticket-font { font-family: 'Courier Prime', monospace; }
        
        .bg-store-gradient {
            background: linear-gradient(rgba(220, 38, 38, 0.9), rgba(153, 27, 27, 0.9)), 
                        url('https://images.unsplash.com/photo-1534723452862-4c874018d66d?auto=format&fit=crop&q=80&w=1000');
            background-size: cover;
            background-position: center;
        }

        .btn-action {
            transition: all 0.2s;
            border-radius: 8px;
        }
        .btn-action:active { transform: scale(0.95); }

        /* Optimizaciones para móvil */
        @media (max-width: 768px) {
            .pos-layout { flex-direction: column !important; }
            .cart-panel { width: 100% !important; height: 50vh !important; }
            .grid-products { grid-template-columns: repeat(2, 1fr) !important; }
            .header-info { display: none; }
        }

        @media print {
            body * { visibility: hidden; }
            #ticket-modal, #ticket-modal * { visibility: visible; }
            #ticket-modal { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; }
            #ticket-modal button { display: none; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-store-gradient z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-sm w-full border-t-8 border-red-600">
            <div class="text-center mb-6 md:mb-8">
                <div class="inline-block p-4 bg-red-50 rounded-full mb-4">
                    <i class="fas fa-store text-4xl text-red-600"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-black text-gray-800 font-['Oswald'] uppercase tracking-tight">MINI SUPER CARLITOS</h2>
                <p class="text-gray-500 text-xs font-bold">ACCESO AL SISTEMA</p>
            </div>
            
            <div id="role-selection" class="space-y-3">
                <button onclick="selectRole('owner')" class="w-full flex items-center justify-between p-4 border-2 border-gray-100 rounded-xl hover:border-red-500 hover:bg-red-50 transition group">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-shield text-red-600"></i>
                        <span class="font-bold text-gray-700">DUEÑO</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-600"></i>
                </button>
                <button onclick="selectRole('employee')" class="w-full flex items-center justify-between p-4 border-2 border-gray-100 rounded-xl hover:border-gray-800 hover:bg-gray-50 transition group">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-cash-register text-gray-700"></i>
                        <span class="font-bold text-gray-700">EMPLEADO</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 group-hover:text-gray-800"></i>
                </button>
            </div>

            <div id="password-entry" class="hidden space-y-4">
                <button onclick="backToRoles()" class="text-xs text-red-600 font-bold mb-2 flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i> VOLVER
                </button>
                <input type="password" id="login-pass" placeholder="PIN" class="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-red-600 outline-none text-center text-2xl tracking-widest font-bold">
                <button onclick="attemptLogin()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-red-700">ENTRAR</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header-brand p-3 md:p-4 flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-3 md:gap-6">
            <div class="flex flex-col">
                <h1 class="text-xl md:text-2xl font-black leading-none tracking-tighter">MINI SUPER CARLITOS</h1>
                <span class="text-[8px] md:text-[10px] font-bold opacity-80">TECNOLOGÍA EN TU BARRIO</span>
            </div>
            <span id="role-indicator" class="text-[8px] md:text-[10px] px-2 py-1 rounded border border-white font-bold uppercase"></span>
        </div>
        <div class="flex items-center gap-4 md:gap-6">
            <div id="clock" class="text-xs md:text-sm font-mono font-bold header-info">00:00:00</div>
            <button onclick="logout()" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition border border-white/20">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </header>

    <!-- Navegación -->
    <nav id="nav-bar" class="bg-gray-200 border-b flex px-2 md:px-4 gap-1 pt-2 shadow-inner overflow-x-auto no-scrollbar"></nav>

    <main class="flex-1 overflow-hidden relative">
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl shadow-md border-l-8 border-emerald-500">
                    <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Ventas de Hoy</span>
                    <div id="profit-day" class="text-3xl md:text-4xl font-black text-emerald-600">$0.00</div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-8 border-red-600">
                    <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Fiados Pendientes</span>
                    <div id="total-fiados" class="text-3xl md:text-4xl font-black text-red-600">$0.00</div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-8 border-gray-800">
                    <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Stock Crítico</span>
                    <div id="low-stock-count" class="text-3xl md:text-4xl font-black text-gray-800">0</div>
                </div>
            </div>
        </div>

        <!-- POS -->
        <div id="view-pos" class="hidden h-full flex flex-col lg:flex-row p-2 md:p-4 gap-2 md:gap-4 pos-layout">
            <div class="flex-1 flex flex-col gap-2 md:gap-4 overflow-hidden">
                <div class="bg-white p-3 md:p-4 rounded-xl shadow-md flex items-center gap-3 border-2 border-red-100">
                    <div class="bg-red-600 text-white p-2 md:p-3 rounded-lg">
                        <i class="fas fa-barcode text-lg md:text-xl"></i>
                    </div>
                    <input type="text" id="barcode-scanner" oninput="searchProduct(this.value)" placeholder="BUSCAR PRODUCTO..." class="flex-1 text-lg md:text-2xl font-black outline-none uppercase placeholder:text-gray-300">
                </div>
                <div id="pos-grid" class="flex-1 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-3 overflow-y-auto custom-scroll pr-1 content-start grid-products"></div>
            </div>

            <div class="w-full lg:w-[400px] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden border-2 border-gray-800 cart-panel">
                <div class="p-3 bg-gray-800 text-white flex justify-between items-center">
                    <h3 class="font-bold text-xs tracking-widest uppercase"><i class="fas fa-shopping-basket mr-2"></i> CARRITO</h3>
                    <button onclick="clearCart()" class="text-[9px] bg-red-600 px-2 py-1 rounded font-bold hover:bg-red-700">VACIAR</button>
                </div>
                <div id="cart-list" class="flex-1 overflow-y-auto p-3 space-y-1 custom-scroll bg-[#fcfcfc] ticket-font text-xs"></div>
                <div class="p-4 md:p-6 bg-gray-50 border-t-2 border-dashed border-gray-300">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-500 font-bold uppercase text-[10px] md:text-xs">Total</span>
                        <span id="cart-total" class="text-3xl md:text-4xl font-black text-red-600">$0.00</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 md:gap-3">
                        <button onclick="openCheckout('cash')" class="bg-emerald-600 text-white p-3 md:p-4 rounded-xl font-bold hover:bg-emerald-700 shadow-md flex flex-col items-center btn-action">
                            <i class="fas fa-money-bill-alt text-xl mb-1"></i> EFECTIVO
                        </button>
                        <button onclick="openCheckout('fiado')" class="bg-red-600 text-white p-3 md:p-4 rounded-xl font-bold hover:bg-red-700 shadow-md flex flex-col items-center btn-action">
                            <i class="fas fa-user-clock text-xl mb-1"></i> FIAR
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FIADOS -->
        <div id="view-fiados" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-600">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black font-['Oswald'] text-gray-800 uppercase">Clientes</h2>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">CUENTAS POR COBRAR</p>
                    </div>
                    <button id="add-customer-btn" onclick="openModal('customer-add-modal')" class="w-full md:w-auto bg-gray-800 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-black transition">+ NUEVO CLIENTE</button>
                </div>
                <div id="customers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
            </div>
        </div>

        <!-- INVENTARIO -->
        <div id="view-inventory" class="hidden h-full p-4 md:p-6 overflow-y-auto custom-scroll">
            <div class="bg-white rounded-xl shadow-lg max-w-6xl mx-auto overflow-hidden">
                <div class="p-4 md:p-6 bg-gray-800 text-white flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                    <h2 class="text-lg font-black uppercase tracking-widest">Inventario</h2>
                    <div class="flex w-full sm:w-auto gap-2">
                        <button onclick="sendLowStockWhatsApp()" class="flex-1 sm:flex-none bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp"></i> STOCK
                        </button>
                        <button onclick="openProductModal()" class="flex-1 sm:flex-none bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-700">+ PRODUCTO</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px]">
                        <thead class="bg-gray-100 text-gray-600 text-[10px] font-black uppercase tracking-tighter border-b">
                            <tr>
                                <th class="p-4 text-left">Producto</th>
                                <th class="p-4 text-left">Precio</th>
                                <th class="p-4 text-center">Stock</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALES VARIOS (MODIFICADOS PARA MÓVIL) -->
    <div id="ticket-modal" class="hidden fixed inset-0 bg-black/90 z-[700] flex items-center justify-center p-4">
        <div class="bg-white p-6 max-w-[320px] w-full ticket-font text-[12px] shadow-2xl rounded-xl border-t-8 border-red-600 overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-4">
                <div class="text-lg font-bold uppercase font-['Oswald']">MINI SUPER CARLITOS</div>
                <div id="ticket-date" class="mt-1 text-[9px] opacity-60"></div>
            </div>
            <div class="border-t border-b border-dashed border-gray-400 py-3 my-3 space-y-1" id="ticket-items"></div>
            <div class="flex justify-between font-black text-base">
                <span>TOTAL:</span>
                <span id="ticket-total"></span>
            </div>
            <div class="text-center mt-6 space-y-3">
                <p class="text-[9px]">¡GRACIAS POR SU COMPRA!</p>
                <div class="flex flex-col gap-2 no-print">
                    <button onclick="window.print()" class="bg-gray-800 text-white w-full py-3 rounded-lg font-bold text-xs">IMPRIMIR</button>
                    <button onclick="closeModal('ticket-modal')" class="bg-red-600 text-white w-full py-3 rounded-lg font-bold text-xs uppercase">CERRAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="hidden fixed inset-0 bg-black/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 md:p-8 border-t-8 border-red-600">
            <h3 id="checkout-title" class="text-lg font-black text-center uppercase mb-4 tracking-widest"></h3>
            <div id="checkout-total-display" class="text-5xl font-black text-center text-red-600 mb-6 font-['Oswald']"></div>
            
            <div id="cash-payment-fields" class="space-y-4 hidden">
                <input type="number" id="cash-received" oninput="calcChange()" placeholder="PAGA CON..." class="w-full p-4 bg-gray-50 border-2 rounded-xl text-3xl text-center font-black focus:border-emerald-500 outline-none">
                <div class="bg-gray-100 p-3 rounded-xl border-2 border-dashed border-gray-300 text-center">
                    <span class="text-[10px] text-gray-500 font-black uppercase">Cambio</span>
                    <div id="cash-change" class="text-2xl font-black text-emerald-600">$0.00</div>
                </div>
            </div>

            <div id="fiado-fields" class="space-y-3 hidden">
                <label class="text-[10px] font-black text-gray-400 uppercase">Seleccionar Cliente</label>
                <select id="customer-select" class="w-full p-4 bg-gray-50 border-2 rounded-xl font-bold text-lg outline-none"></select>
            </div>

            <div class="pt-4 space-y-2">
                <button onclick="finalizeSale()" class="w-full bg-red-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-red-700 uppercase tracking-widest btn-action">CONFIRMAR</button>
                <button onclick="closeModal('checkout-modal')" class="w-full text-gray-400 font-bold text-xs py-2 uppercase">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 bg-black/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-md border-t-8 border-red-600 overflow-y-auto max-h-[90vh]">
            <h3 class="font-black mb-4 text-lg uppercase tracking-widest">PRODUCTO</h3>
            <form id="product-form" class="space-y-3" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="p-id">
                <input type="text" id="p-code" placeholder="CÓDIGO DE BARRAS" class="w-full p-3 border-2 rounded-xl font-mono outline-none">
                <input type="text" id="p-name" required placeholder="NOMBRE / DESCRIPCIÓN" class="w-full p-3 border-2 rounded-xl font-bold uppercase outline-none">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="p-cost" step="0.01" placeholder="COSTO" class="w-full p-3 border-2 rounded-xl outline-none">
                    <input type="number" id="p-price" step="0.01" required placeholder="PRECIO VENTA" class="w-full p-3 border-2 rounded-xl font-bold text-red-600 outline-none">
                </div>
                <input type="number" id="p-stock" required placeholder="STOCK" class="w-full p-3 border-2 rounded-xl outline-none">
                <button type="submit" class="w-full bg-gray-800 text-white py-4 rounded-xl font-black mt-2 uppercase hover:bg-black transition">GUARDAR</button>
                <button type="button" onclick="closeModal('product-modal')" class="w-full text-gray-400 text-[10px] font-bold uppercase">CANCELAR</button>
            </form>
        </div>
    </div>

    <div id="customer-add-modal" class="hidden fixed inset-0 bg-black/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm border-t-8 border-gray-800">
            <h3 class="text-lg font-black mb-4 uppercase tracking-widest">NUEVO CLIENTE</h3>
            <input type="text" id="new-cust-name" placeholder="NOMBRE COMPLETO" class="w-full p-4 bg-gray-50 border-2 rounded-xl mb-4 font-bold outline-none">
            <button onclick="saveNewCustomer()" class="w-full bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-700">REGISTRAR</button>
            <button onclick="closeModal('customer-add-modal')" class="w-full text-gray-400 text-[10px] font-bold mt-4 uppercase text-center w-full">Cerrar</button>
        </div>
    </div>

    <div id="customer-detail-modal" class="hidden fixed inset-0 bg-black/90 z-[650] flex items-center justify-center p-2 md:p-4">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[95vh] shadow-2xl">
            <div class="p-4 bg-red-600 text-white flex justify-between items-center">
                <h3 id="det-cust-name" class="text-xl font-black font-['Oswald'] uppercase truncate pr-4"></h3>
                <button onclick="closeModal('customer-detail-modal')" class="text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 bg-red-50 text-center border-b-2 border-dashed border-red-200">
                <span class="text-[9px] font-black text-red-400 uppercase tracking-widest">Deuda Actual</span>
                <div id="det-cust-balance" class="text-5xl font-black text-red-600 font-['Oswald']"></div>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-4 bg-gray-50">
                <div class="bg-white border-2 border-gray-200 p-4 rounded-xl">
                    <p class="text-[9px] font-black text-gray-400 uppercase mb-2">Abonar</p>
                    <div class="flex gap-2">
                        <input type="number" id="abono-monto" placeholder="$0.00" class="flex-1 p-3 bg-gray-50 border rounded-xl font-black text-lg outline-none">
                        <button onclick="registerAbono()" class="bg-emerald-600 text-white px-4 rounded-xl font-black uppercase text-xs">OK</button>
                    </div>
                </div>
                <div id="customer-history" class="space-y-2"></div>
            </div>

            <div id="customer-footer-actions" class="p-4 border-t bg-white grid grid-cols-2 gap-2">
                <button onclick="liquidarCuenta()" class="bg-gray-800 text-white py-3 rounded-lg font-black text-[10px] uppercase">LIQUIDAR</button>
                <button onclick="eliminarCliente()" class="bg-red-100 text-red-600 py-3 rounded-lg font-black text-[10px] uppercase">ELIMINAR</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all z-[1000] pointer-events-none font-black uppercase text-xs text-center min-w-[200px]"></div>

<script>
// ===============================
// LÓGICA DEL SISTEMA
// ===============================

let products = [];
let sales = [];
let customers = [];
let cart = [];
let currentRole = null;
let selectedRoleAttempt = null;
let saleType = "cash";
let selectedCustomerId = null;

const DB = {
    save() {
        localStorage.setItem("pos_products", JSON.stringify(products));
        localStorage.setItem("pos_sales", JSON.stringify(sales));
        localStorage.setItem("pos_customers", JSON.stringify(customers));
    },
    load() {
        products = JSON.parse(localStorage.getItem("pos_products")) || [];
        sales = JSON.parse(localStorage.getItem("pos_sales")) || [];
        customers = JSON.parse(localStorage.getItem("pos_customers")) || [];
    }
};

window.onload = () => {
    DB.load();
    updateClock();
    setInterval(updateClock, 1000);
};

function updateClock() {
    const el = document.getElementById("clock");
    if (el) el.innerText = new Date().toLocaleTimeString();
}

function selectRole(role) {
    selectedRoleAttempt = role;
    document.getElementById('role-selection').classList.add('hidden');
    document.getElementById('password-entry').classList.remove('hidden');
    document.getElementById('login-pass').value = "";
    document.getElementById('login-pass').focus();
}

function backToRoles() {
    document.getElementById('role-selection').classList.remove('hidden');
    document.getElementById('password-entry').classList.add('hidden');
}

function attemptLogin() {
    const pass = document.getElementById('login-pass').value;
    const valid = selectedRoleAttempt === "owner" ? "admin123" : "user123";

    if (pass === valid) {
        currentRole = selectedRoleAttempt;
        document.getElementById("login-overlay").classList.add("hidden");
        
        const indicator = document.getElementById("role-indicator");
        indicator.innerText = currentRole === "owner" ? "Dueño" : "Empleado";
        indicator.className = `text-[8px] md:text-[10px] px-2 py-1 rounded border font-bold uppercase ${currentRole === 'owner' ? 'bg-white text-red-600' : 'bg-black text-white'}`;
        
        initTabs();
    } else {
        showToast("PIN INCORRECTO");
    }
}

function logout() { location.reload(); }

function initTabs() {
    const tabs = currentRole === "owner" 
        ? [{id:'dashboard', name:'INICIO', icon:'fa-chart-pie'}, {id:'pos', name:'CAJA', icon:'fa-cash-register'}, {id:'fiados', name:'FIADOS', icon:'fa-users'}, {id:'inventory', name:'STOCK', icon:'fa-boxes'}]
        : [{id:'pos', name:'CAJA', icon:'fa-cash-register'}, {id:'fiados', name:'FIADOS', icon:'fa-users'}];

    const nav = document.getElementById("nav-bar");
    nav.innerHTML = "";
    tabs.forEach(t => {
        const btn = document.createElement("button");
        btn.id = `tab-${t.id}`;
        btn.className = "px-4 md:px-6 py-3 bg-gray-300 rounded-t-xl text-[10px] md:text-xs font-bold text-gray-600 transition flex items-center gap-2 whitespace-nowrap flex-shrink-0";
        btn.innerHTML = `<i class="fas ${t.icon}"></i> ${t.name}`;
        btn.onclick = () => switchTab(t.id);
        nav.appendChild(btn);
    });
    switchTab(tabs[0].id);
}

function switchTab(tabId) {
    document.querySelectorAll("main > div").forEach(v => v.classList.add("hidden"));
    document.getElementById("view-" + tabId).classList.remove("hidden");
    
    document.querySelectorAll("#nav-bar button").forEach(b => b.classList.remove("tab-active"));
    document.getElementById("tab-" + tabId).classList.add("tab-active");

    if (tabId === "dashboard") renderDashboard();
    if (tabId === "pos") renderPOS();
    if (tabId === "fiados") renderCustomers();
    if (tabId === "inventory") renderInventory();
}

function renderDashboard() {
    const today = new Date().toDateString();
    const todaySales = sales.filter(s => new Date(s.date).toDateString() === today);
    const totalDay = todaySales.reduce((acc, s) => acc + s.total, 0);
    const totalDebt = customers.reduce((acc, c) => acc + (c.balance || 0), 0);
    const lowStock = products.filter(p => p.stock < 5).length;

    document.getElementById("profit-day").innerText = `$${totalDay.toFixed(2)}`;
    document.getElementById("total-fiados").innerText = `$${totalDebt.toFixed(2)}`;
    document.getElementById("low-stock-count").innerText = lowStock;
}

function renderPOS(filter = "") {
    const grid = document.getElementById("pos-grid");
    grid.innerHTML = "";
    const filtered = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()) || p.code.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(p => {
        const btn = document.createElement("button");
        btn.className = "bg-white p-3 rounded-xl shadow hover:shadow-lg border-b-4 border-gray-200 active:border-b-0 active:translate-y-1 transition text-left flex flex-col justify-between h-28 md:h-32";
        btn.innerHTML = `
            <span class="text-[9px] md:text-[10px] font-black text-gray-500 uppercase leading-tight line-clamp-2">${p.name}</span>
            <div class="flex flex-col">
                <span class="text-[8px] font-bold text-gray-400">Stock: ${p.stock}</span>
                <span class="text-lg md:text-xl font-black text-red-600 leading-none">$${p.price.toFixed(2)}</span>
            </div>`;
        btn.onclick = () => addToCart(p);
        grid.appendChild(btn);
    });
}

function searchProduct(val) { renderPOS(val); }

function addToCart(product) {
    if (product.stock <= 0) { showToast("SIN EXISTENCIAS"); return; }
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
        if (existing.qty < product.stock) existing.qty++;
        else showToast("STOCK MÁXIMO");
    } else cart.push({ ...product, qty: 1 });
    renderCart();
}

function renderCart() {
    const list = document.getElementById("cart-list");
    list.innerHTML = "";
    let total = 0;
    cart.forEach((item, index) => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        list.innerHTML += `
            <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0">
                <div class="flex-1">
                    <div class="uppercase font-bold text-gray-800 text-[10px] truncate w-32">${item.name}</div>
                    <div class="text-[8px] text-gray-400">${item.qty} x $${item.price.toFixed(2)}</div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold">$${subtotal.toFixed(2)}</span>
                    <button onclick="removeFromCart(${index})" class="text-red-500 px-1"><i class="fas fa-times-circle"></i></button>
                </div>
            </div>`;
    });
    document.getElementById("cart-total").innerText = `$${total.toFixed(2)}`;
}

function removeFromCart(index) { cart.splice(index, 1); renderCart(); }
function clearCart() { cart = []; renderCart(); }

function openCheckout(type) {
    if (cart.length === 0) return showToast("VACÍO");
    saleType = type;
    const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
    document.getElementById("checkout-total-display").innerText = `$${total.toFixed(2)}`;
    document.getElementById("checkout-title").innerText = type === "cash" ? "PAGO EFECTIVO" : "REGISTRAR FIADO";
    document.getElementById("cash-payment-fields").classList.toggle("hidden", type !== "cash");
    document.getElementById("fiado-fields").classList.toggle("hidden", type !== "fiado");
    if (type === "fiado") {
        const select = document.getElementById("customer-select");
        select.innerHTML = customers.map(c => `<option value="${c.id}">${c.name.toUpperCase()}</option>`).join("");
        if (customers.length === 0) { showToast("NO HAY CLIENTES"); return; }
    } else {
        document.getElementById("cash-received").value = "";
        document.getElementById("cash-change").innerText = "$0.00";
    }
    openModal("checkout-modal");
}

function calcChange() {
    const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
    const received = parseFloat(document.getElementById("cash-received").value) || 0;
    document.getElementById("cash-change").innerText = `$${Math.max(0, received - total).toFixed(2)}`;
}

function finalizeSale() {
    const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
    if (saleType === "cash") {
        const received = parseFloat(document.getElementById("cash-received").value) || 0;
        if (received < total) return showToast("PAGO INSUFICIENTE");
    }
    const sale = { 
        id: crypto.randomUUID(), 
        date: new Date().toISOString(), 
        items: [...cart], 
        total: total, 
        type: saleType, 
        customerId: saleType === "fiado" ? document.getElementById("customer-select").value : null 
    };
    cart.forEach(item => { const p = products.find(x => x.id === item.id); if (p) p.stock -= item.qty; });
    if (saleType === "fiado") {
        const customer = customers.find(c => c.id === sale.customerId);
        if (customer) {
            customer.balance = (customer.balance || 0) + total;
            customer.history = customer.history || [];
            customer.history.unshift({ date: new Date().toISOString(), type: 'deuda', amount: total, details: cart.map(i => i.name).join(", ") });
        }
    }
    sales.unshift(sale); DB.save(); showToast("VENTA OK"); closeModal("checkout-modal"); showTicket(sale); clearCart(); renderPOS();
}

function renderCustomers() {
    const grid = document.getElementById("customers-grid");
    grid.innerHTML = "";
    document.getElementById("add-customer-btn").style.display = currentRole === "owner" ? "block" : "none";

    customers.forEach(c => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow cursor-pointer border-l-4 " + (c.balance > 0 ? "border-red-500" : "border-emerald-500");
        card.onclick = () => openCustomerDetail(c.id);
        card.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <h4 class="font-bold text-gray-800 uppercase text-xs truncate w-40">${c.name}</h4>
                <i class="fas fa-chevron-right text-gray-200 text-xs"></i>
            </div>
            <div class="text-[8px] font-black text-gray-400 uppercase">Saldo</div>
            <div class="text-2xl font-black ${c.balance > 0 ? 'text-red-600' : 'text-emerald-600'} font-['Oswald']">$${(c.balance || 0).toFixed(2)}</div>`;
        grid.appendChild(card);
    });
}

function openCustomerDetail(id) {
    const c = customers.find(x => x.id === id);
    if (!c) return;
    selectedCustomerId = id;
    document.getElementById("det-cust-name").innerText = c.name;
    document.getElementById("det-cust-balance").innerText = `$${(c.balance || 0).toFixed(2)}`;
    document.getElementById("customer-footer-actions").style.display = currentRole === "owner" ? "grid" : "none";

    const history = document.getElementById("customer-history");
    history.innerHTML = (c.history || []).slice(0, 5).map(h => `
        <div class="p-3 bg-white border rounded-xl text-[10px]">
            <div class="flex justify-between font-bold text-gray-400 uppercase">
                <span>${new Date(h.date).toLocaleDateString()}</span>
                <span class="${h.type === 'abono' ? 'text-emerald-600' : 'text-red-600'}">${h.type}</span>
            </div>
            <div class="font-black text-sm">$${h.amount.toFixed(2)}</div>
        </div>`).join("");
    
    openModal("customer-detail-modal");
}

function registerAbono() {
    const amount = parseFloat(document.getElementById("abono-monto").value);
    if (!amount || amount <= 0) return showToast("INVALIDO");
    const c = customers.find(x => x.id === selectedCustomerId);
    if (amount > c.balance) return showToast("EXCEDE DEUDA");
    
    c.balance -= amount;
    c.history.unshift({ date: new Date().toISOString(), type: 'abono', amount: amount, details: 'Abono en caja' });
    DB.save(); showToast("ABONO OK"); openCustomerDetail(c.id); renderCustomers();
}

function liquidarCuenta() {
    if (!confirm("¿LIQUIDAR?")) return;
    const c = customers.find(x => x.id === selectedCustomerId);
    if (c.balance <= 0) return;
    c.history.unshift({ date: new Date().toISOString(), type: 'abono', amount: c.balance, details: 'Liquidación' });
    c.balance = 0; DB.save(); closeModal("customer-detail-modal"); renderCustomers();
}

function eliminarCliente() {
    if (!confirm("¿ELIMINAR?")) return;
    customers = customers.filter(x => x.id !== selectedCustomerId);
    DB.save(); closeModal("customer-detail-modal"); renderCustomers();
}

function saveNewCustomer() {
    const name = document.getElementById("new-cust-name").value.trim();
    if (!name) return;
    customers.push({ id: crypto.randomUUID(), name: name, balance: 0, history: [] });
    DB.save(); document.getElementById("new-cust-name").value = ""; closeModal("customer-add-modal"); renderCustomers();
}

function renderInventory() {
    const body = document.getElementById("inventory-body");
    body.innerHTML = "";
    products.forEach(p => {
        const row = document.createElement("tr");
        row.className = p.stock < 5 ? "bg-red-50" : "";
        row.innerHTML = `
            <td class="p-4"><div class="text-xs font-bold uppercase truncate w-32">${p.name}</div></td>
            <td class="p-4 font-black text-red-600 text-xs">$${p.price.toFixed(2)}</td>
            <td class="p-4 text-center"><span class="px-2 py-1 rounded-lg font-black text-[10px] ${p.stock < 5 ? 'bg-red-600 text-white' : 'bg-gray-100'}">${p.stock}</span></td>
            <td class="p-4 text-right">
                <div class="flex justify-end gap-3">
                    <button onclick='editProduct("${p.id}")' class="text-blue-500"><i class="fas fa-edit"></i></button>
                    <button onclick='deleteProduct("${p.id}")' class="text-red-400"><i class="fas fa-trash"></i></button>
                </div>
            </td>`;
        body.appendChild(row);
    });
}

function handleProductSubmit(e) {
    e.preventDefault();
    const id = document.getElementById("p-id").value;
    const data = { 
        id: id || crypto.randomUUID(), 
        code: document.getElementById("p-code").value, 
        name: document.getElementById("p-name").value.toUpperCase(), 
        cost: parseFloat(document.getElementById("p-cost").value) || 0, 
        price: parseFloat(document.getElementById("p-price").value), 
        stock: parseInt(document.getElementById("p-stock").value) 
    };
    if (id) { const idx = products.findIndex(x => x.id === id); products[idx] = data; }
    else products.push(data);
    DB.save(); closeModal("product-modal"); renderInventory();
}

function editProduct(id) {
    const p = products.find(x => x.id === id);
    document.getElementById("p-id").value = p.id;
    document.getElementById("p-code").value = p.code;
    document.getElementById("p-name").value = p.name;
    document.getElementById("p-cost").value = p.cost;
    document.getElementById("p-price").value = p.price;
    document.getElementById("p-stock").value = p.stock;
    openModal("product-modal");
}

function deleteProduct(id) { if (confirm("¿ELIMINAR?")) { products = products.filter(x => x.id !== id); DB.save(); renderInventory(); } }

function openProductModal() { 
    document.getElementById("product-form").reset(); 
    document.getElementById("p-id").value = ""; 
    openModal("product-modal"); 
}

function sendLowStockWhatsApp() {
    const lowStock = products.filter(p => p.stock < 5);
    if (lowStock.length === 0) return showToast("TODO OK");
    let msg = "*⚠️ REPORTE STOCK - CARLITOS*\n\n";
    lowStock.forEach(p => msg += `• ${p.name}: ${p.stock}\n`);
    window.open(`https://wa.me/2371062600?text=${encodeURIComponent(msg)}`, '_blank');
}

function showTicket(sale) {
    document.getElementById("ticket-date").innerText = new Date(sale.date).toLocaleString();
    document.getElementById("ticket-items").innerHTML = sale.items.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name.substring(0,15)}</span><span>$${(i.qty * i.price).toFixed(2)}</span></div>`).join("");
    document.getElementById("ticket-total").innerText = `$${sale.total.toFixed(2)}`;
    openModal("ticket-modal");
}

function openModal(id) { document.getElementById(id).classList.remove("hidden"); }
function closeModal(id) { document.getElementById(id).classList.add("hidden"); }

function showToast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg; t.classList.add("opacity-100", "bottom-14");
    setTimeout(() => t.classList.remove("opacity-100", "bottom-14"), 2000);
}
</script>
</body>
</html>